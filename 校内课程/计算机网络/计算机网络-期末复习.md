---
title: 计算机网络 期末复习
categories:
  - 校内课程
  - 计算机网络
abbrlink: fe75e45c
date: 2023-09-19 02:00:00
updated: 2023-09-19 02:00:00
---

<meta name="referrer" content="no-referrer"/>

# 第一章 计算机网络和因特网

## 计算机网络的两大功能

* 连通性
* 共享性

## Internet具体构成

* 数以亿计的**计算互连设备、通信链路、分组交换**：路由器和交换机

<!-- more -->

  * 主机（host）=端系统（end system）

    * 运行网络应用程序

  * 通信链路(link)

    双绞线,光纤, 无线电频谱, 卫星
    传输速率 = 带宽(bandwidth)
    带宽单位为bps，bit per second每秒传输的位数，例如百兆光纤就是100M bps，实际传输使用的单位为BPS，1B=8bit，所以传输速率为100/8=12.5M BPS，就是12.5MB/s
    通信链路只有极限带宽，例如5号线极限带宽为300M，不能接千兆网卡，只能接百兆网卡
    网卡有传输的能力，传输速率取决于网卡能传输的能力，例如百兆，千兆网卡

  * 分组(packet)交换：

    - 路由器（Router）和交换机（Switch）
    - 交换机：形成局域网
    - 路由器：链接互联网

## 协议的基本要素

* **语法：语法即是用户数据与控制信息的结构和格式**
* **语义：语义即是需要发出控制信息，以及完成的动作与做出的响应**
* **同步：同步可以理解为时序，即是对事件实现顺序的详细说明**

## 网络核心

![image-20230626202145007](https://img-blog.csdnimg.cn/9eeff579290b4c9cb2f3905f713490d1.png)

### 电路交换

电话交换机接通电话线的方式成为电路交换

<img src="https://img-blog.csdnimg.cn/adde999f37f444cfba64d5dc03ba9dbc.png" alt="image-20230621153107716" style="zoom:67%;" />

* **每次会话预留沿其路径（线路）所需的独占资源**－－电话网

* 从主机A到主机B经一个电路交换网络需要多长时间发送一个640Kb的文件?
  **电路交换的频分和时分**

  <img src="https://img-blog.csdnimg.cn/1b92f917a2f143bda4774e1c1b230477.png" alt="image-20230621153149234" style="zoom:67%;" />

  举例子：

  ![image-20230608113428494](https://img-blog.csdnimg.cn/82b06b27b6a74383ac1e3b8010b2fe31.png)

* 过程

  * 建立连接
    * 会一直霸占着这条路径
  * 传输数据 
  * 释放连接   

* 优点

  * 传输速度快、高效
  * 实时

* 缺点

  * 资源利用率低
  * 新建连接需要占据一定的时间，甚至比通话的时间还长



###  多路复用

* 数据以离散的数据块通过网络来发送
  - 分片分配到会话
  - 分片没有被会话使用的情况下，分片空载(不共享)
  - 电路级性能（有保证）
  - 要求呼叫建立－－建立一个专门的端到端线路(意味着每个链路上预留一个线路)
  - 链路带宽分片

频分－frequency division

时分－time division

### 分组交换

![image-20230625162813284](https://img-blog.csdnimg.cn/3b2c592fcc2a4f36a5595800c558387c.png)

每个端到端的**数据流被划分成分组**

- **所有分组共享网络资源**

- **每个分组使用全部链路带宽**

- 资源按需使用 

  ![image-20230608125358197](https://img-blog.csdnimg.cn/cbd6da00979c4cce976640a800c2dd31.png)

### 报文交换

![image-20230625162842346](https://img-blog.csdnimg.cn/f6f745d89ebd4e89945514b816a6156b.png)

## 比较分组交换与电路交换：

![image-20230625162932841](https://img-blog.csdnimg.cn/8360b60c7ef34dfbadbf670e20b5c91b.png)

* 分组交换允许更多的用户使用网络
* ![image-20230608124857481](https://img-blog.csdnimg.cn/2a479291cb3b43349f2a6b142f5ac706.png)
* **优势**
  * **适合大量的突发数据传输**
  * **资源共享**
  * **简单，无需连接**
* **缺点**
  * **过渡竞争导致分组延迟与丢失**
  * **需要可靠数据传输、拥塞控制协议**

## 网络的分类

![image-20230608130446056](https://img-blog.csdnimg.cn/de014a23da48404d81d6c45a43bd9209.png)

* 图中FDM频分，TDM时分
* **虚电路网络一定是面向连接的**
* 数据报网络既可以提供面向连接的服务，也可以提供无连接的服务

## 四种时延

  1.节点**处理时延**nodal processing delay：分析地址部分，进行差错检验等花费的时间

	检查错误位
	选择输出链路
	高速路由器处理延迟－微秒级

2. **排队时延**queueing delay：在进入路由器之后等待处理的时间

等待被发送到输出链路上的时间
取决于路由器的拥塞程度

3. **传输(发送)时延**Transmission delay：**从发送分组的第一个bit算起，到该分组最后一个分组被发送完毕需要的时间**

R=链路带宽 (bps)
L=分组长度 (bits)
发送分组比特流的时间 = L/R

4. **传播时延**Propagation delay：一个比特从链路一端传播到另一端所需要的时间

d = 物理链路的长度
s = 介质的信号传播速度 (~2x108 m/sec)
传播延迟 = d/s
注意: s和R是两个完全不同的速度参量!

![image-20230608132042272](https://img-blog.csdnimg.cn/24a63c1a96c3473491df2ffcaf143669.png)

### 总的节点延迟

![image-20230608132348394](https://img-blog.csdnimg.cn/979f67f658f1421b8282f100c3f95c8c.png)

* dproc = **处理时延**
* dqueue = **排队时延**
* dtrans = **传输时延**
* dprop = **传播时延**

![image-20230608142947297](https://img-blog.csdnimg.cn/a29a81845f754e2abb7541e3fe493516.png)

## 流量强度

### 流量强度=分组长度L*平均分组到达率a/链路带宽R

L=分组长度 (bits)

a=平均分组到达率 average packet arrival rate

R=链路带宽 (bps)

**流量强度：traffic intensity = La/R**

### 流量强度与延迟关系

La/R ~ 0: 分组稀疏到达,无队列,平均排队延迟极小接近于0

La/R -> 1: 分组猝发到达,形成队列,队列长度迅速增加,排队延迟大幅增大

La/R > 1: 输出队列平均位到达速率超过送走这些位的极限速率，输出队列持续增长，排队延迟趋于无穷大

![image-20230621155021702](https://img-blog.csdnimg.cn/e3b4b49565504054b4889e4bda234cf5.png)

## 分组丢失

- **路由器输入链路和输出链路的缓冲区容量有限**
- 当分组到达路由器**输入链路**发现缓冲区已满，则路由器只好丢弃分组
- 当分组在路由器内部要**转发到输出链路**时发现输出缓冲区队列已满，路由器只好丢弃分组
- 丢失的分组可能被前路由节点、源节点重传，或不重传
- 丢包率或分组丢失率（packet loss rate/ratio）

## 吞吐量

* 网络吞吐量：

  * 单位时间内**整个网络传输数据的速率或分组数**

* bps或data packets per second

* 吞吐量: 接收端接收到数据的比特速率 (bps )

  瞬时吞吐量: 某一瞬间的吞吐量

  平均吞吐量: 一段时间内的吞吐量均值

## 各层次常用协议

### 分层次结构

![image-20230626145237281](https://img-blog.csdnimg.cn/e2a5b0eee0e3432c817ac7408081d511.png)

### 应用层

* 支持网络应用，报文传
* FTP, SMTP, STTP

### 传输层

* 主机**进程间**的数据段传送
* TCP、UDP

### 网络层

* **主机与主机**间分组传送

* IP、路由协议

### 链路层

* **相邻网络节点间**的数据帧传送
* PPP(Point to Point Protocol)，Ethernet

### 物理层

* 物理介质上的比特传送

* 对等实体:
  *  两台计算机上**同一层**所属的程序、进程或实体称为该层的对等程序、对等进程或对等实体

![image-20230608195253093](https://img-blog.csdnimg.cn/04b92bc5f0554fd4ab1bb08bc4c62048.png)

# 第二章 应用层

![image-20230625144139781](https://img-blog.csdnimg.cn/f5bf4f938c2b4275a94206bf4430e0f0.png)

## 两种方式

### 客户机/服务器 CS

![image-20230625144543419](https://img-blog.csdnimg.cn/8ced4924ead4446a93a00caf00d191cf.png)

* 服务器：具有客户资源
  * **总是打开的主机**
  * 具有固定的、**众所周知的IP地址**
  * 主机群集常被用于创建强大的虚拟服务器

* 客户机：发出请求和接受数据
  * 同服务器端通信
  * 可以间断的同服务器连接
  * 可以拥有**动态IP地址**
  * **客户机相互之间不直接通信**

### 对等 P2P方式

![image-20230625144650971](https://img-blog.csdnimg.cn/0b21ff5efff148debe52b058a6086c53.png)

## 进程通信

* 进程
  * 运行在端系统中的程序
* 同一主机上的两个进程通过**内部进程通信机制**进行通信
* 不同主机上的进程通过**交换报文**相互通信

## 套接字

* 又叫应用程序编程接口API

## 进程寻址

**IP地址+端口号**

## web应用和HTTP

* 网页

* 由许多**对象**组成

* **对象就是文件**，可以是HTML文件, JPEG图像, Java applet, 音频文件…

  **多数网页由单个基本HTML文件和若干个所引用的对象构成**

  * 每一个对象对应一个URL

### 使用TCP：HTTP属于应用层，使用运输层的TCP进行传输

* 1 客户初始化一个与**HTTP服务器80端口**的TCP连接(创建套接字)
* 2 HTTP服务器接受来自客户的TCP连接请求, 建立连接
* 3 Browser (HTTP client)和Web服务器 (HTTP server) **交换HTTP消息**(应用层协议消息)包括**HTTP请求和响应消息**
* 4 最后结束，关闭TCP连接

### HTTP是无状态协议

* **HTTP服务器不维护客户先前的状态信息**

<img src="https://img-blog.csdnimg.cn/321073bac1834510851320db8543b483.png" alt="image-20230622095533346" style="zoom:67%;" />

### 非持久的HTTP连接

![image-20230625160406926](https://img-blog.csdnimg.cn/21e6a16f00314ffe9459cdba5dfe167e.png)

* **每个TCP连接上只传送一个对象**，下载多个对象需要建立多个TCP连接

* **HTTP/1.0使用非持久HTTP连接**

* **非持久HTTP**详解

  * 假设用户输入URL http://www.someSchool.edu/someDepartment/home.index 网页由1个HTML文件, 和10个jpeg图像构成
  * 解析步骤

  > 第一步：**建立TCP连接**
  >
  > * HTTP客户机初始化与服务器主机中HTTP服务器的**TCP连接**
  > * 服务器中HTTP服务器**在80端口监听TCP连接**。收到请求连接，接受，建立连接，通知客户
  >
  > 第二步：**HTTP请求连接**
  >
  > * HTTP客户发送HTTP请求消息，包含**URL到TCP连接套接字**，消息指出客户所需要的**web对象**
  > * HTTP服务器接受请求消息，产生一个**响应消息**，包含**被请求对象**，并发送这个消息到自身TCP连接套接字
  > * **HTTP服务器结束TCP连接**
  > * HTTP **客户接收**包含html文件的响应消息, 显示html. **解析**html文件，**找出10个jpeg对象**
  > * **对十个引用对象重复上述操作(图中是并行的，串行的话需要一个一个按顺序来)**

* 在非持久HTTP连接下，上述只需4RTT

* **由于是非持续的，那么建立一次连接服务器返回消息之后就会断开连接，所以先建立TCP连接，发HTTP请求得到HTML对象，然后解析得到10个图片对象然后重新建立连接发送请求就得到对象了**

* ![image-20230608210341182](https://img-blog.csdnimg.cn/c8914f0a9aea4201a8fd2ce50b8a98c0.png)

* 缺点：

  * 每个对象都需要2个RTT
  * OS必须为每个TCP连接分配主机资源
  * **大量客户的并发TCP连接形成服务器的严重负担**



### 持久HTTP连接

![image-20230625160449725](https://img-blog.csdnimg.cn/68b590c4fe34440aa6d5fb633d6e969e.png)

* **一个TCP连接上可以传送多个对象，也就是说建立TCP连接之后正常状态下等整个过程结束之后再断开，保证了持续性**
* HTTP/1.1默认使用持久HTTP连接

* 例题

* ![image-20230608203521193](https://img-blog.csdnimg.cn/461a8f0834284f95800bb360da6b4afc.png)

#### **不带流水线**(可以理解为串行)的持久HTTP连接

- 客户先前响应消息收到,才发出新的请求消息
- 每个引用对象经历1个RTT
- ![img](https://img-blog.csdnimg.cn/b4e9b97c777740a2b4356b9a84acf969.png)

#### 带流水线(可以理解为并行)的持久HTTP连接：最优解决方案

- **HTTP/1.1默认使用**
- 客户遇到1个引用对象就发送请求消息
- 所有**引用对象只经历1个RTT**
- ![image-20230608212737400](https://img-blog.csdnimg.cn/3249e37b906040df838c7451fc8ff69c.png)

例子：

<img src="https://img-blog.csdnimg.cn/f49c0ed2e70c4f1fbfbf3080d40715e4.png" alt="image-20230622101111027" style="zoom:67%;" />

<img src="https://img-blog.csdnimg.cn/3723477ba0cc433981c1b498743316a1.png" alt="image-20230622101120944" style="zoom: 80%;" />

### 响应时间模型

* 定义往返时间RTT(Round-Trip Time):
  * 响应时间:
    - **1个RTT用于建立TCP连接**
    - **1个RTT用于HTTP请求/响应消息的交互**
    - **Html文件传输时间**
  * **total = 2RTT+transmit time**
* ![img](https://img-blog.csdnimg.cn/be331d150c374b22b4b413b7f42b9913.png)

## HTTP报文格式

* 请求报文（ASCII文本：易于人读的格式）![img](https://img-blog.csdnimg.cn/3f236cad54d946c7b3853a6a0598bde4.png)

![img](https://img-blog.csdnimg.cn/85af8b807d83431a8c1fdf846c24efd5.png)

* 响应报文![img](https://img-blog.csdnimg.cn/2cea3785b2434e10976812efd38ae508.png)

  

## cookie：跟踪用户

**cookie文件是存在用户本地的!!!**

**把无状态的Http协议进行状态化!!!**

![image-20230625160547504](https://img-blog.csdnimg.cn/c3358641929442e98e40ea8783168803.png)

![image-20230625160642445](https://img-blog.csdnimg.cn/6ea3164a3df54ed888a7c11f81d67baf.png)

<img src="https://img-blog.csdnimg.cn/ca047d91089f4c8baef843c8bc7926c8.png" alt="image-20230622102736462" style="zoom:80%;" />

Cookie和隐私：

- Cookies允许网站更加了解你
- 你可以给网站提供名字和e-mail给网站
- 广告公司通过网站获得信息
- **Cookies不适合游动用户**

## web缓存(代理服务器)

![image-20230626151239998](https://img-blog.csdnimg.cn/92b9ab90225c413a8949e175511f93b9.png)

![image-20230625160723037](https://img-blog.csdnimg.cn/6d554689f3b1483bbf8f00846b8c46bc.png)

- **目标：在不访问服务器的情况下满足用户的Http请求**(代表**起始服务器**满足HTTP请求)
- 一般有ISP(Internet服务提供商)架设

**所有HTTP请求指向缓存**

- **对象在缓存中：缓存器返回对象**
- **否则缓存器向起始服务器发出请求，接收对象后转发给客户机**
- 这么看起来缓存既可以充当服务器给用户返回对象，也可以充当客户端向起始服务器发送请求

**为什么需要Web服务器？**

- 减少对客户机请求的响应时间
- 减少内部网络与接入链路上的通信量
- 能从整体上大大降低因特网上的Web流量

**条件get方法**

**确认缓存服务器中的对象是否为最新的**，使用户拿到最新的数据

<img src="https://img-blog.csdnimg.cn/3b7597b216404785b66c703b867a4781.png" alt="image-20230622103720853" style="zoom: 67%;" />

web缓存中的文件都有两个附加字段，last-modified最近一次修改时间和expires有效时间

先请求web缓存，如果未过期，则直接返回；如果过期了，则请求原始服务器

![image-20230625160849149](https://img-blog.csdnimg.cn/6d8b92eb23fd4851965aea69c8d3e839.png)

**web缓存向原始服务器发送请求，包含last-modified，和自己的进行比对，如果相同则返回304 not modified，不附加其他数据，如果已更改，就返回已更改的对象**

![image-20230625161204742](https://img-blog.csdnimg.cn/8b0414f10cca47088b290ffdcaccb6e3.png)

## FTP文件传送协议

### 概念

![image-20230625154249351](https://img-blog.csdnimg.cn/8e8138a2088044238e1e17400644751d.png)

### 主动模式

![image-20230625154416832](https://img-blog.csdnimg.cn/75dccf0a22464e37b4c8e9a03ad04c10.png)

### 被动模式

![image-20230625154502992](https://img-blog.csdnimg.cn/a40168aa56ff4224abaf4fcdffdba035.png)

### 例题





## 电子邮件

![image-20230626152139341](https://img-blog.csdnimg.cn/8eb91043621047b3bfa8305bd2bf5ba0.png)

结构：**用户代理，邮件服务器，电子邮件使用的协议**

![image-20230625154716555](https://img-blog.csdnimg.cn/0aa871447a504196842a1bb8f659e02d.png)

![image-20230622104337427](https://img-blog.csdnimg.cn/58bb3cd63e824efb9ef81119f2381aeb.png)

过程

![image-20230625154835044](https://img-blog.csdnimg.cn/d68e9bcac52c48b7b388937a83b39855.png)

**用户代理(UA)：**

用户和电子邮件系统的接口

用户代理向用户提供一个很友好的接口来发送和接收邮件，用户代理至少应当具有**撰写、显示和邮件处理**的功能

**邮件服务器：**

它的功能是发送和接收邮件，同时还要向发信人报告邮件传送的情况（已交付、被拒绝、丢失等）。

**邮件服务器采用客户/服务器方式工作，**

但它必须能够同时充当客户和服务器邮件发送协议和读取协议∶

邮件发送协议用于用户代理向邮件服务器发送邮件或在邮件服务器之间发送邮件，如SMTP;

邮件读取协议用于用户代理从邮件服务器读取邮件，如POP3

**SMTP用的是“推”（Push）的通信方式，POP3用的是“拉”（Pull）的通信方式**

**电子邮件格式与MIME**

<img src="https://img-blog.csdnimg.cn/45dc9aafaad04af88d1929244996b870.png" alt="image-20230622104736561" style="zoom: 80%;" />

**多用途网际邮件扩充（MIME）**

**由于SMTP只能传送一定长度的ASCII码，**

许多其他**非英语国家的文字**（如中文、俄文，甚至带重音符号的法文或德文）就**无法传送**，

且**无法传送可执行文件及其他二进制对象**，因此提出了用途网络邮件扩充

### SMTP

* Simple Mail Transfer Protocol

* 客户使用 **TCP** 来可靠传输邮件消息到 **服务器端口号25**

* **直接传送**: 发送服务器到接收服务器

* 传输的3个阶段

  * **连接建立(握手)**

    发件人的邮件发送到发送方的邮件服务器的缓存中；

    SMTP客户每隔一段时间就对邮件缓存扫描一次，如果发现有邮件就建立TCP连接

  * **邮件消息的传输**

    连接建立后，就可开始传送邮件。邮件的传送从 **MAIL 命令开始**，MAIL 命令后面有发件人的地址

  * **连接释放(结束)**

    邮件发送完毕后，SMTP 客户应**发送 QUIT 命令**。

    SMTP 服务器**返回的信息是 221（服务关闭）**，表示 SMTP 同意释放TCP 连接

* 命令/应答的交互

  * 命令: ASCII文本格式
  * 应答: 状态码及其短语

* ![image-20230608215240462](https://img-blog.csdnimg.cn/b944c3cff86f4a8e9d25dbe8b442dd46.png)

  ![img](https://img-blog.csdnimg.cn/84b4ebc17cbf40caa85135792199844a.png)

* SMTP总结

  * SMTP使用**持久连接**
  * SMTP 要求邮件消息(header & body)必须是**7-bit ASCII**、

* SMTP与HTTP的比较

  * HTTP：**拉**协议
  * SMTP：**推**协议
  * HTTP: **每个对象封装在它各自的HTTP响应消息中发送**

  * SMTP: **一个邮件内各个对象置于同一个邮件消息的多目部分发送**

  ![image-20230622105516615](https://img-blog.csdnimg.cn/48e18fa6b25d4090bd30f33f4ec0354f.png)

#### Mime

**SMTP协议只能传送7bit的ASCII码文本数据，不能传可执行文件或者其他二进制对象**

**SMTP不能传送多媒体文件，以及其他非英语国家的文字**

**解决不能传送ASCII码数据的问题，一处多用途因特网邮件扩展MIME**

**MIME还可以用于面向非ASCII码的Http！！！**

![image-20230625155233199](https://img-blog.csdnimg.cn/1963f836e37a4b4e9bead28445919c85.png)

### POP3和IMAP

POP也使用**客户/服务器的工作方式，在传输层使用TCP，端口号为110**。**IMAP4使用143**

POP有两种工作方式：

**"下载并保留"和"下载并删除"**

![image-20230625155503271](https://img-blog.csdnimg.cn/ed5b49d6621b42c988693f9474aec2e9.png)

### 基于万维网的电子邮件

![image-20230625155648766](https://img-blog.csdnimg.cn/7299311f7edf41cba8ce02d0706ef1cf.png)

### 邮件消息的格式

* SMTP: 用来交换邮件消息的协议

* RFC 822: **文本邮件消息格式标准**

* 信头－头部行。如：

  To:

  From:

  Subject:

  这些头部不同于SMTP命令!

  信体

  邮件消息也必须是**ASCII字符**

  **![img](https://img-blog.csdnimg.cn/cfbcd6f0dd394bf5af944c2b37aa8bb8.png)**

## DNS

### 关于主机名和域名

![image-20230625162532115](https://img-blog.csdnimg.cn/b77fd2388aea47fd9fb492d908e4c22c.png)

### 概述

![image-20230625151306770](https://img-blog.csdnimg.cn/0cc20cc12c4342b69f5cf1db2be4dcc3.png)

### 域名系统

![image-20230625151534819](https://img-blog.csdnimg.cn/f3ba98da0ab749f8a31c9f380d3b9c9f.png)

* 功能
  * **主机名到IP地址的转换**
  * 主机别名：**一个主机可以有一个规范主机名和多个主机别名**
  * **邮件服务器别名**
  * **负载分配**：DNS实现冗余服务器：一个IP地址集合可以对应于同一个规范主机名
* 特点：
  * 分布式数据库：一个由分层DNS服务器实现的分布式数据库
  * 应用层协议：DNS服务器实现域名转换 (域名/地址转换)

* 为什么不集中式DNS？
  * 单点故障
  * 巨大访问量
  * 远距离集中式数据库
  * 维护
  * 难以扩展

* DNS分类![img](https://img-blog.csdnimg.cn/7a7c7c35065d410abef64fb4147e0514.png)

![image-20230625151837823](https://img-blog.csdnimg.cn/030be6f81744487dab08641ce9991217.png)

或者这么划分

![image-20230625152255881](https://img-blog.csdnimg.cn/c89c3b9f65f34537959452b7f11a0319.png)

**根名字服务器**

* 根名字服务器负责**记录顶级域名服务器的信息**

**顶级域名服务器**

* **负责顶级域名** com, org, net, edu, etc, 和**所有国家的顶级域名** uk, fr, ca, jp.

**权威DNS服务器**

在因特网上具有公共可访问主机（如Web服务器和邮件服务器）的每个组织机构必须提供公共可访问的DNS记录，

这些记录将这些主机的名字映射为IP地址。

组织机构的权威DNS服务器负责保存这些DNS记录。

**多数大学和公司维护它们的基本权威DNS服务器**

**本地DNS服务器**

* 严格来说不属于该服务器的层次结构

* **每个ISP（如居民区ISP、公司、大学）都有一个本地DNS也叫默认服务器**

  当**主机发出DNS请求时，该请求被发往本地DNS服务器**。

  起着**代理的作用**，转发请求到层次结构中。

### 递归查询

![img](https://img-blog.csdnimg.cn/5f87cec1a6d44e519191d97945ac8c78.png)

### 迭代查询

![img](https://img-blog.csdnimg.cn/fac2c882ae714ca1a315f69902ebca41.png)

总结

**递归查询：我帮你查了，妈的；查不到我让你帮我查，查到了告诉我**

**迭代查询：我不知道，但是我可以让你去找别人**

**注意，本地域名服务器查不到直接向跟域名服务器请求，然后才是接下来的操作**

**本地主机中也有DNS高速缓存，当高速缓存有的时候就不需要进入本地域名服务器了**

![image-20230625152530509](https://img-blog.csdnimg.cn/8232d56b35774cfb9091323da0e9e7e4.png)

#### 例题

![image-20230625153307625](https://img-blog.csdnimg.cn/3a9fb14edfc642c7b161a956eebe9815.png)

### DNS缓存和权威DNS记录更新

![image-20230625153001648](https://img-blog.csdnimg.cn/0148c9ebb293458b9f1f9ad7d22c8e6b.png)

* **一旦名字服务器获得DNS映射, 它将缓存该映射到局部内存**
* **服务器在一定时间后将丢弃缓存信息**
* **本地DNS服务器可以缓存TLD服务器的IP地址**

### DNS记录

RR 格式: (name, value, type,ttl)

* Type=A（Address地址）
  * name = 主机名
    value = IP地址
* Type=CNAME（canonical别名）
  * name = 主机别名：www.ibm.com的真名为servereast.backup2.ibm.com
    value = 真实的规范主机名

* Type=NS（ name server ）
  * name = 域名（如foo.com）
    value = 该域权威名字服务器的主机名

* Type=MX（mail exchange）
  * name =邮件服务器的主机别名
    value =邮件服务器的真实规范主机名

![image-20230622111347168](https://img-blog.csdnimg.cn/a1b95c96920c482d94f69c8d999a7e2b.png)

### DNS协议

* **查询报文与应答报文** , 但具有**同样的报文格式**

* 报文头部

  * **标识符: 16位**，查询和应答报文使用相同的标识符

  * 标志:有若干个标志构成，分别标识不同的功能

    查询/应答－0/ 1

    查询希望是/非递归查询－1/0

    应答可/否获得(支持)递归查询－1/0

    应答是/否来自权威名字服务器－1/ 0

![img](https://img-blog.csdnimg.cn/ea9bf51d56fd40c6947e72edb65c2246.png)

## 应用层协议小节

![image-20230622103454264](https://img-blog.csdnimg.cn/e197caf3ab524cfb9affd6936f794e40.png)

<img src="https://img-blog.csdnimg.cn/fde8d59789f24b1897de20ea9fb3dd59.png" alt="image-20230626153219335" style="zoom:67%;" />

# 第三章 运输层

**运输层通信的双方是进程到进程，而网络层是主机到主机**

![image-20230624154115769](https://img-blog.csdnimg.cn/8ce78f3caf15491b936afd11c9289757.png)

**运输层屏蔽了下层网络核心的细节，使应用进程看起来就好像是两个运输层实体之间有一条端到端的逻辑通信通道!!!**

**运输层使用端口号来区分不同的应用进程！！！**

![image-20230624154451660](https://img-blog.csdnimg.cn/88697c055bb848fb9129873c4ab3ae58.png)

## 概念

**从通信和信息处理的角度看，传输层向它上面的应用层提供通信服务，它属于面向通信部分的最高层，同时也是用户功能中的最低层**

**传输层位于网络层之上，它为运行在不同主机上的进程之间提供了逻辑通信，而网络层提供主机之间的逻辑通信。**

**显然，即使网络层协议不可靠（网络层协议使分组丢失、混乱或重复），传输层同样能为应用程序提供可靠的服务**

**传输层提供应用进程之间的逻辑通信（即端到端的通信）**

**与网络层的区别是，网络层提供的是主机之间的逻辑通信复用和分用。**

在两个不同的**主机**上运行的**应用程序之间提供逻辑通信**

* 传输层协议运行在**端系统**

  * 发送方: 将**应用程序报文**分成**数据段**传递给网络层

  * 接受方: 将**数据段重新组装成报文**传递到应用层

* **两个进程**之间的逻辑通信
* 可靠, 增强的网络层服务

## 端口号

**引入端口号的原因：不同操作系统对进程PID的表示不同，为了统一，就是用端口号来在网络中表示应用层的不同进程**

![image-20230624155032903](https://img-blog.csdnimg.cn/61298923ec454baba4b43cc59bc9ce54.png)

##  多路复用和多路分解

![image-20230626192530115](https://img-blog.csdnimg.cn/b7536c10f87946679e2f18d927a27883.png)

![image-20230626153907760](https://img-blog.csdnimg.cn/f6e4cc8ddcd94e91a1e513c20033a33f.png)

**应用层把应用层数据协议单元交给运输层，运输层判断采用udp还是tcp，分别封装为udp对应的用户数据报和tcp对应的tcp报文段，这称作复用，将对应数据交给网络层封装成IP数据报，这称作IP复用，接收方采取相反的策略即可**

![image-20230624155324468](https://img-blog.csdnimg.cn/69a1a3695dc34b0793125fd20c498aef.png)

* 多路复用
  * 多个**套接字收集数据**，用首部封装数据，然后将报文段传递到网络层
* 多路分解
  * 将接收到的**数据段传递到正确的套接字**

![image-20230610092926777](https://img-blog.csdnimg.cn/63414a15f9754c8e80cf1f0eb876258f.png)

* 多路分解工作过程
  * 主机收到**IP数据报**
    * 每个**数据报**有**源IP地址，目的IP地址**
    * 每个**数据报搬运一个数据段**
    * 每个**数据段**有源和目的端口号
    * 主机用IP地址和端口号指明数据段属于哪个合适的套接字
    * ![image-20230610093454073](https://img-blog.csdnimg.cn/853ee35bb33c488f923d55f752cabdb7.png)

![image-20230610095201477](https://img-blog.csdnimg.cn/c4e73c89a828412c9374dfa513cf2ca0.png)

![image-20230610095208923](https://img-blog.csdnimg.cn/eba454c9fe554a95850eea5ba6dcc911.png)

**应用层的协议对应的运输层协议以及端口号**

![image-20230624155741355](https://img-blog.csdnimg.cn/30ca50e844cb4fe4a15358690f1e3285.png)

## TCP和UDP的对比

**udp无连接，tcp有连接**

![image-20230624160900650](https://img-blog.csdnimg.cn/5ead33c3fee3442bba27aa545c2ba785.png)

**udp支持单播，多播和广播，而tcp只支持单播(建立连接)**

![image-20230624161026024](https://img-blog.csdnimg.cn/9f0386ca645f4048a9c9edd7e45b179a.png)

**udp面向应用报文，tcp面向字节流**

**udp仅加上一个udp数据首部；**

**tcp将应用层协议数据单元视作连续的字节流，以字节为基础进行发送，然后在接受方重新拼接**

![image-20230624161311376](https://img-blog.csdnimg.cn/7aa399562b6d4d1d8c71eb31276ac5d9.png)

**udp提供无连接不可靠的服务，tcp提供面向连接的可靠服务**

![image-20230624161607588](https://img-blog.csdnimg.cn/90827704e9d6468bbfddc26012f1443e.png)

**udp和tcp的首部不同**

![image-20230624161902155](https://img-blog.csdnimg.cn/edf5c90e294b4a6f9d1b7944cbfc11a3.png)

## UDP

**UDP使用应用层协议提供可靠性!!!!!**

### 概述

* 提供**尽力而为**的服务
* 数据报可能**丢失**、**传递失序的报文到应用程序**
* **无连接**
* **UDP 是面向报文的。发送方 UDP 对应用程序交下来的报文，在添加首部后就向下交付**

### UDP 存在原因

* 无需建立连接，**减少延迟**
* **简单**，在发送者和接受者之间不需要连接状态
* **很小的数据段首部**。首部开销小，只有 **8 个字节**
* **没有拥塞控制**，UDP 能够用尽可能快的速度传递
* UDP 支持一对一、一对多、多对一和多对多的交互通信

![image-20230610100140495](https://img-blog.csdnimg.cn/66ff645cbd4c4e07bf455dd96b36afa0.png)

### 首部

* UDP首部格式
* ![image-20230622113800850](https://img-blog.csdnimg.cn/96ddbe5836de4bcf85a87b38592eeec4.png)
* ![image-20230610100226345](https://img-blog.csdnimg.cn/595ccf5e86ad4bfe8d3162c658a7c711.png)
  * 首部字段8字节，4个字段，每个字段2字节
  * 长度是首部和数据的总长度
  * 源端口： 源端口号，**需要对方回信时选用**，不需要时全部置0
  * 长度：UDP的数据报的长度（包括首部和数据）其最小值为8（只有首部）
  * 校验和：检测UDP数据报在传输中是否有错，有错则丢弃。该字段是可选的，当源主机不想计算校验和，则直接令该字段全为0
* 校验和的计算![image-20230610100731124](https://img-blog.csdnimg.cn/368609096dcb4581b8d87544b939e61d.png)
  * **17是协议代号，表示UDP**
  * 伪首部的作用：
    * **伪首部既不向下传送也不向上递交，而只是为了计算校验和**
    * 通过**伪首部的IP地址检验**，UDP可以确认该数据报是不是发送给本机IP地址的
    * 通过伪首部的**协议字段检验**，UDP可以确认IP有没有把不应该传给UDP而应该传给别的高层的数据报传给了UDP
    * 伪首部的UDP长度=UDP数据包的UDP包长度字段值
    * 识别一个通信应用需要**5个因素**。"**源IP地址"、"目标IP地址"、"源端口"、"目标端口"、"协议号"**。UDP首部只包含了（源端口和目标端口），用此来校验，如果其他三项信息被破坏，极有可能导致应收包应用收不到，不应该收包的应用收到。为此，有必要在通信中，验证这5项的识别码是否正确，就引入了伪首部的概念。

### 校验和

#### 伪首部(12个字节)

![image-20230626154652376](https://img-blog.csdnimg.cn/c3a9a84d574447ecaa94661fe11db67c.png)

**在计算校验和的时候，UDP数据报之前需要加上 12B 的伪首部，伪首部并不是UDP的真正首部，只是在计算校验和的时候，加在前面构成一个临时的数据报，校验和既不向下传送也不向上递交，只是为了计算校验和**

![image-20230610104343725](https://img-blog.csdnimg.cn/2b613e8ed174421a9d6cd3d9a431a13a.png)

* 校验和例子
  ![image-20230622114417726](https://img-blog.csdnimg.cn/90d0db3f636c47608fb57e2cd822ba52.png)

  * 求和时产生的进位必须回卷到结果上![image-20230610104505148](https://img-blog.csdnimg.cn/2332d660c9cb48aab9478f9e34e633d0.png)
  * **累加和按位取反得到校验和**

  ![image-20230626154905222](https://img-blog.csdnimg.cn/6f1215bbb28246868234d2cca39f6245.png)

## TCP

### MSS

- **MSS: TCP 报文段中数据字段的最大长度，而 MSS 通常根据 MTU（最大链路层帧）来设置。**

**熟知端口号：0-1023；可提供 2^16个 不同端口**

**TCP 是在不可靠的 IP 层之上实现的可靠的(rdt服务)数据传输协议，它主要解决传输的可靠、有序、无丢失和不重复问题。**

### 特点

* 点到点：

  * 面向连接的运输层协议
  * 一个发送者，一个接收者
  * 可靠按序的**字节流**

* 可靠：

  * 提供可靠的交付服务
  * 传输的数据无差错，不丢失，不重复且有序

* 面向字节流：

  * 虽然应用程序和 TCP的交互是一次一个数据块（大小不等）
  * 但TCP把应用程序交下来的数据仅视为一连串的**无结构的字节流**

* 全双工数据：

  * 允许通信双方的应用进程在任何时候都能发送数据
  * 发送和接受双方都设有发送缓存和接收缓存，临时存放双方通信的数据
  * 同一个连接上的**双向数据流**
  * **MSS: 最大报文段长**

  

* 没有信息边界

  * 流水线

* TCP**拥塞控制**设置窗口大小

  * 收发缓冲区

* 面向连接

  * 在数据交换前握手
  * 初始化发送方和接收方数据

* **流量控制**

  * **发送方不会淹没接收方**

### 报文段结构

报文段分为首部和数据两个部分

#### **MSS：TCP允许的最大数据段长度!!!不包含TCP首部!!!**

#### 首部(20固定长度+40扩展首部)

##### 序号

**32bit，指出本报文段数据载荷的第一个字节的序号**

![image-20230624194645563](https://img-blog.csdnimg.cn/8fa86df7aa0e4981b05be582546c644a.png)

##### 确认号

代表希望收到的下一个数据载荷第一个字节的序号，页是最前面所有数据的确认

![image-20230624194827426](https://img-blog.csdnimg.cn/d4e4ed4ae8f84eadac3bf1d239548d3b.png)

**在建立连接之后所有的报文段都设置ACK=1，ACK=0的数据无效**

![image-20230624194924537](https://img-blog.csdnimg.cn/41219e398667429f97af2d22733a63d8.png)

##### 数据偏移

**4bit，并且以4字节为单位，实际上指出了TCP首部的长度，实际大小取决于扩展首部**![image-20230624195352270](https://img-blog.csdnimg.cn/f57649e344de495bb4e2abd7a1cd8e79.png)

##### 保留

占6bit，保留为今后使用，目前设置为0

![image-20230624195520027](https://img-blog.csdnimg.cn/1c8078af3b534d99b9f53c8ecc6b0e23.png)

##### 窗口

**指出发送本报文一方的接收窗口**

![image-20230624195651516](https://img-blog.csdnimg.cn/3a46c20e4bf049dea243b47f1def196d.png)

##### 校验和

**计算检验和时需要加上12字节的伪首部，和udp一样**

![image-20230624195812962](https://img-blog.csdnimg.cn/4bcbbe0414da434d83761a4fdf4f91f6.png)

##### SYN同步标志位

![image-20230624200003160](https://img-blog.csdnimg.cn/8e249b709b5645be899b5cbeecbddd34.png)

##### FIN终止标志位

![image-20230624200030220](https://img-blog.csdnimg.cn/90c13411fd264ddfa80a79df57e40f6a.png)

##### RST复位标志位

![image-20230624200101317](https://img-blog.csdnimg.cn/65448e74e5ad4d8c8ce1a92bf7a35aad.png)

##### PSH推送标志位

![image-20230624200125573](https://img-blog.csdnimg.cn/892392095e6b44999105c92603134d25.png)

##### URG紧急标志位

![image-20230624200206137](https://img-blog.csdnimg.cn/b0188f7d0ceb4f41acc5f6be85a7af0f.png)

##### 选项

![image-20230624200330171](https://img-blog.csdnimg.cn/069e0907bc684963b9f415393bb6f784.png)

##### 填充

![image-20230624200343658](https://img-blog.csdnimg.cn/6ab8bc264de94a2da71bc351378f73d2.png)

* 首部格式 **20字节**

![image-20230611111822653](https://img-blog.csdnimg.cn/8dd71b2f1a1d4082a615d9d422b9fed9.png)

> 源端口目的端口：2字节
>
> **序号Seq**：**4字节**，TCP连接中传送的数据流中的每一个字节都编上一个序号。序号字段的值则指的是本报文段所发送的**数据的第一个字节的序号**
>
> **确认号**：**期望接收**的下一个报文段的数据的第一个字节的序号；如果是N，则表示到序号 N-1 为止，所有数据都正确收到
>
> 数据偏移：**4比特，以32为为单位，首指出 TCP 报文段的数据起始处距离 TCP 报文段的起始处有多远；因此当此字段的值为 15 时，达到 TCP 首部的最大长度 60B**
>
> 紧急位 URG：URG=1时，表明紧急指针字段有效。它告诉系统此报文段中有**紧急数据**，应尽快传送（相当于高优先级的数据）
>
> **确认位 ACK：确认。只有当ACK=1时确认号字段才有效。当ACK=0时，确认号无效；TCP规定，在连接建立之后所有传送的报文段都必须把ACK置为1**
>
> 推送位 PSH：接收方TCP收到PSH=1的报文段，**就尽快地交付给接收应用进程，而不再等到整个缓存都填满后再向上交付**
>
> 同步位 SYN：**SYN=1 表示这是一个连接请求或连接接收报文**
>
> 终止位 FIN：**用来释放一个连接**。当 FIN = 1时，表明此报文段的发送方的数据已发送完毕，并要求释放传输连接。
>
> RST：当RST=1时表示出现严重差错，必须释放连接重新建立连接
>
> FIN：FIN=1，表明次报文段的发送端数据已发送完毕并要求释放连接
>
> 窗口：2字节，让对方设置发送窗口的依据。单位是字节
>
> 检验和：2字节，**检验首部和数据两个部分。计算检验和时，要在TCP报文段前面加上12字节的伪首部(和UDP相同)**
>
> 保留字段：6位，全为0

![image-20230611115955959](https://img-blog.csdnimg.cn/c109f918d3e84dd2a0937e1e340b8752.png)

### 可靠数据传输

基本概念

![image-20230624112452840](https://img-blog.csdnimg.cn/a53abce85b0f47089c32131133158172.png)

**有线链路误码率较低，一般交给运输层来进行处理；但是无线链路易受干扰，误码率比较高，要求数据链路层必须提供可靠数据传输服务**

![image-20230624113111919](https://img-blog.csdnimg.cn/b9dc8be2291941c2aea5dd51180403a4.png)

#### 停等协议SW

![image-20230624141846466](https://img-blog.csdnimg.cn/0808441378d04d67badfb5df9126f24d.png)

确认与否认：

**发送方发送一个数据分组之后，必须停止下来等待接收方对于该分组的确认ACK，确认之后才能进行下一个分组的发送，如果发生误码，接收方通过fcs段检测到误码之后就会发送NAK，发送方就重传该分组，所以在收到确认之前，发送方不能删除该分组的缓存**

超时重传：

**若分组发生丢失，这种情况在数据链路层的传递不太容易发生，但是在不同网络之间，通过路由器连接形成的复杂网络系统下就是经常发生的事情，这个时候需要设置一个超市定时器，如果超时了仍然没有收到确认，那么有可能发生了丢失，立即重传**

![image-20230624142621012](https://img-blog.csdnimg.cn/636042c76087414d8277caf1e449ff96.png)

确认丢失：

确认ACK丢失了，超时进行重传，那么接收方如何判断收到的是相同的分组呢？

给发送数据的分组加上序号，**在停等协议中使用01即可，一个bit位**，当接收方发现两个数据相同则丢弃；

那么如果确认分组迟到了呢？第四个图

ACK0迟到了，导致超时重传DATA0，接收方收到DATA0之后将其丢弃并且发送ACK，那么这个时候发送方就受到了两个一样的确认分组了，同理带上序号，ACK0第二次收到就被丢弃；在前面收到ACK0的时候发送DATA1，接收方收到并且发送ACK1，这就和前面的不同了，所以可以接着发送下一个数据

**由此可见，序号的作用是用来判断该分组和上一个分组是否相同，所以用01就可以了，一个bit位**

信道利用率

![image-20230624143449246](https://img-blog.csdnimg.cn/7dbfa5d64818484fab1ef0e85aa381cb.png)

信道利用率一般比较低，如果超时重传那更低了，所以产生了另外两种协议

#### 回退N帧协议GBN

**是一种连续ARQ协议**

无差错情况

**发送窗口和接收窗口，在回退N帧协议中，接收窗口大小固定为1，发送方看情况**

**假设这里用3个bit，也就是0-7；发送窗口的大小取值范围为![image-20230624144647008](https://img-blog.csdnimg.cn/b0c70a50623c40ef8f261621117c456a.png)，这里取5**，取1就是停等协议

**发送方在发送的过程中，可以连续将发送窗口内的分组发给接收方，假设正确接收，每接受一个，接收方就返回一个ACK确认分组，并且把接收窗口后移，发送方接收到确认分组之后就把发送窗口后移，并且可以将确认完的分组将缓存中删除了**

**注意，接受并且后移的时候分组的序号要和窗口当前的序号相匹配**

![image-20230624144535472](https://img-blog.csdnimg.cn/0fbd0daed3fd4881bfa7d2e6c353e1ed.png)

累计确认

接收方可以不用一个一个发送确认，可以用累计确认，比如ACK1表示1及其以前的所有分组被正确接收，也就是0 1

这里假设发送ACK1和ACK4，ACK1丢失了，但是可以通过ACK4得知已经正确接收，所以省掉了重传的步骤

**即使发生确认分组丢失，发送方也不一定就必须重传!**

并且还可以减少网络资源的占用，减小接收方的开销等等

![image-20230624145045893](https://img-blog.csdnimg.cn/f8b310dd30a040b8af05acb340f6b716.png)

有差错情况

**这里5号分组发生了误码，被接受方丢弃了，剩余的分组与接收窗口不匹配，接收方无法接受，只能将这四个分组丢弃**

![image-20230624145401922](https://img-blog.csdnimg.cn/d906140438814919b1d6fdf20d1bec15.png)

**丢弃之后，每丢弃一个序号不匹配的分组，就发送一个已经接受的ACK，这里就是ACK4，发送方接收到这些确认分组之后，就知道发送出现了问题，根据具体实现来确定收到几个重复确认来重传，总之，要么就是不等计时器重传，要么就是等待计时器结束然后进行重传**

**数据链路层的ACK和运输层的ack有区别，数据链路层的ACKn标识n及其以前的数据分组被正确接收**

![image-20230624145520200](https://img-blog.csdnimg.cn/70dd89d7574b4848904e4dfcd17d06fd.png)

GO-Back-N

![image-20230624145758063](https://img-blog.csdnimg.cn/20ff70521b0d4afda0470e128bd58c02.png)

**发送窗口超过上限举例**

发送窗口在这里的范围显示是：1< Wt <=7，不能取8，当取8时如下

发送方一次性发送0-7，接收方正确接收并且发送累计确认ACK7，但是确认分组丢失了，于是超时之后重传该分组，重复分组进来之后发现0和0匹配，可以接受，但是这个时候接受的是重复的分组，就出现了问题

**接收方无法分辨新旧分组!!!!**

![image-20230624145910991](https://img-blog.csdnimg.cn/39f2462c035f49a1b33e24cd229f4f56.png)

总结

![image-20230624150405134](https://img-blog.csdnimg.cn/46fa106b439a4b419228267d857586ca.png)

#### 选择重传协议SR

选择重传的接收窗口应该大于1，接收方只能按序接受正确到达的数据分组

**选择重传应采用逐一确认而不是累计确认!!!**

![image-20230624150914306](https://img-blog.csdnimg.cn/57d31d138cb64b36b0e9fcfa18d30336.png)

举例：

本例中Wt==Wr==4

**发送方发送0-3号分组，接收方接受的时候2号分组丢失了，接收方先接受01，发送确认分组，然后将接收窗口后移；接受3号分组，但是不能将接收窗口后移，因为接收到的是失序分组，然后返回ACK3**

![image-20230624152052366](https://img-blog.csdnimg.cn/632b9e796e9040d291371a0b7547d2b0.png)

**发送方接收到01分组确认之后就将发送窗口后移，这时候45在里面，可以发送45号数据分组；与此同时，发送方接收到了3号确认分组，将3号分组的定时器暂停避免超时重传，表示已经收到，但是这个时候不能移动发送窗口，因为发送方收到的是失序的确认分组，需要等待2号分组定时器超时，然后进行重传**

![image-20230624152248624](https://img-blog.csdnimg.cn/88797a2c6f4740e381c6a506abcbd6a3.png)

**超时之后重传2号分组，在这之前也许45号分组已经被正确接受，但是由于失序，不能移动接收窗口，发送方接受到确认之后，由于确认分组失序，不能移动发送窗口，并且需要暂停45计时器，现在就只剩下2号分组的重传了**

![image-20230624152555898](https://img-blog.csdnimg.cn/1058b26a8f874045ac3efea7f6d0f30a.png)

**2号分组被正确接收后终于有序，接受窗口后移；发送方接收到确认分组后终于有序，发送窗口后移；进而可以进行后续的传输**

![image-20230624152732620](https://img-blog.csdnimg.cn/d1934ed2a7274b27bb7fa1f6fd0ded3b.png)

发送，接受窗口尺寸问题

![image-20230624152941675](https://img-blog.csdnimg.cn/0d639da91afb4bb7ab4e52d392e99b32.png)

**注意这里和回退N帧区别，一个是 2^(n-1)，一个是2^n -1**

![image-20230624152948624](https://img-blog.csdnimg.cn/9e2702dcb0a14ac18075c951618a8e76.png)

![image-20230624152934773](https://img-blog.csdnimg.cn/5c986c63986e48a3b5b1393f8bd366ac.png)

如果超出界限举例

这个例子最大取4，我们取5

**发送方发送0-4，接收方接受并且返回确认分组，但是0号确认丢失，发送窗口不能移动；但是接收窗口移动了，如图所示**

**一段时间过后重传0号分组，接收方窗口中0存在，可以接受，但是这个0并不是我们想要的0，就导致了无法区分新旧数据分组；**

**如果大小合适接收窗口中应该没有0，这个时候接收方知道确认分组丢失了，所以重新发送确认分组ACK0，发送方接受，正常运作**

![image-20230624153312495](https://img-blog.csdnimg.cn/987911985345448ca346907f7d9f33da.png)

总结

![image-20230624153631576](https://img-blog.csdnimg.cn/6ea0525c7a6045f8bf21b2517b746751.png)

#### Tcp可靠数据传输的实现

##### 比较

![image-20230626163659858](https://img-blog.csdnimg.cn/885ca3456d1344a3acd5bafe543f0042.png)

![image-20230626162902828](https://img-blog.csdnimg.cn/1069aee5b1914ac19eafc1663932217d.png)

**是以上上面三种协议为基础实现的，并没有独立使用哪一种**

**TCP以字节为单位的滑动窗口实现可靠数据传输**

![image-20230624172017010](https://img-blog.csdnimg.cn/e99ba9c2d2fc48afae9fca653dd6a42b.png)

补充：

![image-20230624172654441](https://img-blog.csdnimg.cn/4d253e5269e54f82b1b80f456704c9e3.png)

#### 利用率(重要!!!)

**注意RTT是往返时延，L/R就是指的是传输速率!!!**

![image-20230626160221179](https://img-blog.csdnimg.cn/e9e05d803d544ecd856e1f801a241b2e.png)

![image-20230626160321100](https://img-blog.csdnimg.cn/34980c953a9c4e889346fc93eaffcc7f.png)

##### 例题：

![image-20230624172950070](https://img-blog.csdnimg.cn/f83bf9ca21fa4b93a5095c6e828cbd0e.png)

**注意这里细节：**

**序号500开始，再发送500，最后一个字节是999，ACK是期望收到，所以是ACK1000！！！**

**TCP规定只能对按序到达的最高序号进行确认，所以这个1000实际上是累计确认!!!**

### 可靠传输协议rdt

![image-20230626155514095](https://img-blog.csdnimg.cn/73ddd920269542f88b83f467fa2c8fa3.png)

![image-20230611131502756](https://img-blog.csdnimg.cn/f23bc398505e4f52a06699b344233f73.png)

* FSM：有限状态机
  * 来表示发送方和接收方

#### rdt1.0 完全可靠信道上的可靠数据传输

![image-20230610104840840](https://img-blog.csdnimg.cn/31be477ba7f045f298bf9cd79cd355bd.png)

#### rdt2.0 具有bit错误的信道

![image-20230610105031837](https://img-blog.csdnimg.cn/12cc2eaad51447a99c1ba37fd16c2ce1.png)

* 提供了差错检测和接收方反馈(ACK,NAK)

* ![image-20230610105600242](https://img-blog.csdnimg.cn/f0a80aefcd154e96988ff5946be169ba.png)

* 当没有错误时：![image-20230610105629761](https://img-blog.csdnimg.cn/ddb6cc4e1617494892885db127bf9c0f.png)

* 当发生错误时：![image-20230610105640978](https://img-blog.csdnimg.cn/4daa1c2771984c7e8d48e81e362f12fc.png)

* 停-等协议

  * 发送方发送一个报文，然后等待接受方的响应

* Rdt2.0的致命缺陷

  * **如果ACK/NAK混淆了会发生什么？**

    * 发送方并不知道接收方发生了什么!

      万能做法：**重发**

      不能正确重发: 可能重复

* **处理重复**: 

  发送方给每个分组加一个序号

  在 ACK/NAK 混淆时发送方重发当前分组

  接收方丢弃重复的分组（并不向上传递）

  ——停等协议数据包需要多少序号？

  * ==两个序号 (0,1) 就可以满足==

#### rdt2.1发送方处理•两个序号 (0,1) 就可以满足混乱的ACK/NAKs

![image-20230610110625349](https://img-blog.csdnimg.cn/224f70545b394f2787387205ea90d6b5.png)

rdt2.1接收方处理混乱的ACK/NAKs

![image-20230610110928220](https://img-blog.csdnimg.cn/170750f4ba1d483fba24c4560f38b4c1.png)

* ![image-20230610111910920](https://img-blog.csdnimg.cn/fc3222d323a740e4b9b4f21b5b7abe49.png)

#### rdt2.2一个NAK不要的协议

![image-20230610112013611](https://img-blog.csdnimg.cn/907b5efbf4b74c4b94399c5f626b002a.png)

![image-20230611101310353](https://img-blog.csdnimg.cn/320ae0dd77164a2db0e64c931fb758ba.png)

#### rdt3.0 具有出错和丢失的信道

![image-20230611102248943](https://img-blog.csdnimg.cn/986113db136a459f937521c14ec2e3a5.png)

![image-20230611102257034](https://img-blog.csdnimg.cn/0a160c521e1c40198dda3d0e5b4c009d.png)

![image-20230611102544124](https://img-blog.csdnimg.cn/058d741059de43a095a2ec83aef363c9.png)

![image-20230611102731005](https://img-blog.csdnimg.cn/587476757740466082f0ad5a93a589c9.png)

性能

![image-20230611102940505](https://img-blog.csdnimg.cn/7df144f2725d4ce8b030c874a4855652.png)

![image-20230611102951612](https://img-blog.csdnimg.cn/11d9583c305a4674817409df0ec8cb6e.png)

 ![image-20230611103359901](https://img-blog.csdnimg.cn/afedff4d7b2c47cd89b52b4d5bbfdee8.png)

* 算出来的是发送方的利用率

流水线技术 go-back-N

* 流水线: 发送方允许发送多个 “在路上的”, 还没有确认的报文
  * 序号数目的范围必须增加
  * 在发送方/接收方**必须有缓冲区**

* 增加了利用率![image-20230611103729317](https://img-blog.csdnimg.cn/a9b2116259fb425aa6ec50fbc8711a56.png)



滑动窗口

* ![image-20230611103736771](https://img-blog.csdnimg.cn/eb594959b2e14127a7dc7890cfbac56d.png)

* 发送方:

  * 在分组头中规定一个k位的序号

  * **窗口：允许的连续未确认的报文**

* 接收方：

  * ACK-only: 总是为**正确接收的最高序号的分组发送ACK**

  * 可能生成重复的ACKs

  * **只需要记住被期待接收的序号**expectedseqnum

  * 接收到失序分组: 

    丢弃(不缓冲) -> 没有接收缓冲区!

    重发最高序号分组的ACK![image-20230611105642815](https://img-blog.csdnimg.cn/ab785ab49eec4fcabf35cf8819d479b6.png)

选择性重传 **Selective Repeat, SR**

* 接收方**分别确认已经收到的分组**

  * 必要时，缓冲报文, 最后按序提交给上层

* 发送者**只重发没有收到确认的分组**

  * 对每个没有确认的报文发送者都要启动一个定时器(每个**未被确认的报文都有一个定时器**)

* **发送窗口**

      N 个连续序号
        
      **限制被发送的未确认的分组数量**

* ![image-20230611110149363](https://img-blog.csdnimg.cn/74a28d600d694cadbd036768d872f5fc.png)

* ![image-20230611110459865](https://img-blog.csdnimg.cn/fff63a88dfe3464591d5658ff3d7ff89.png)

  * 接收方收到窗口第一个ACK之后，向后移动一位
    * 收到非首位的ACK，窗口不移动
  * 接收方收到窗口第一个报文之后，向后移动一位
    * 当失序接收时，窗口不移动，记下已接收的报文序号，当窗口中的序号全部接收时，**整体移动**

窗口大小和序号大小的关系

![image-20230611111352285](https://img-blog.csdnimg.cn/f0aa33a01cff4a4f94c8cba9acb811f6.png)

* 窗口≤序号空间大小的一半

* 重发场景![image-20230611132911101](https://img-blog.csdnimg.cn/b844de41f7ff4f50abec7a17da055268.png)

快速重传

* 超时触发重传存在问题:超时周期往往太长——重传丢失报文之前要**等待很长时间**,因此**增加了网络的时延**

  * 发送方可以在超时之前通过重复的ACK检测丢失报文段

  * 发送方常常一个接一个地发送很多报文段

  * 如果报文段丢失,则**发送方**将可能接收到**很多重复的 ACKs**

  * 如果发送方收到一个确认后再收到**3个对同样报文段的确认**，发送方应意识到不对劲——生成三个重复ACK，是因为接收方存在缺失报文段

    **启动快速重传**: 在定时器超时之前重发丢失的报文段

![image-20230611133139299](https://img-blog.csdnimg.cn/cae8f991d7b64cfc8216730cb6a2c969.png)

### 流量控制

运输层的流量控制和数据链路层的流量控制的区别是：

**传输层**定义**端到端用户之间的流量控制**，

**数据链路**层定义两个中间的**相邻结点**的流量控制。

另外，数据链路层的**滑动窗口协议的窗口大小**不能动态变化，**传输层**的则可以**动态变化**

![image-20230611143731217](https://img-blog.csdnimg.cn/e99b4b0d1ff7433bb9824dd32a1c9a0d.png)

* TCP连接的接收方有一个接收缓冲区
* 发送速率和接收应用程序的提取速率匹配
* 流量控制：**发送方不能发送的太多太快，让接收缓冲区溢出**
  * **应用程序可能从这个缓冲区读出数据很慢**

* 工作机制（假设 TCP **接收方丢弃失序的报文段**）
  * 流量控制**使用接收窗口**:接收缓冲区的剩余空间
  * 接收方在**报文段**中宣告接收窗口的**剩余空间**
  * 发送方限制没有确认的数据**不超过接收窗口**

#### 举例

前面的过程不再赘述

![image-20230624162643615](https://img-blog.csdnimg.cn/ca39652fb42049f28348bc76721aed27.png)

后续打破死锁

**发送窗口为0之后启动持续计时器，为什么要引入持续计时器呢？**

**如果等待接收方通知，如果这个报文丢失了那么两方就陷入了互相等待的死锁状态；**

**当持续计时器超时，那么发送零窗口探测报文，如果为0返回确认，然后再启动一个持续计时器；**

**值得一提的是，零窗口探测报文也是具有计时器的，当超时就重发**

**那么接收窗口满了还能接受报文吗？TCP规定，像零窗口探测报文，确认报文，带有紧急事务的报文是必须被接受的!!!**

![image-20230624163134819](https://img-blog.csdnimg.cn/ec39e131f6de45759ab49563ebf05b5e.png)

### TCP建立连接：三次握手

![image-20230624191349583](https://img-blog.csdnimg.cn/f055ccbbbe0745ca966404d8083c8439.png)

**第一步，设置SYN=1,给定一个初始序号seq=x，发送给Tcp服务器；**

**第二步，服务器收到之后发送针对TCP连接请求的确认报文，SYN=1，ACK=1，seq=y，ack=x+1；TCP服务器进入同步已接收状态，TCP客户进入连接已建立状态**

**TCP规定，SYN=1的请求连接的报文不能携带数据，但是需要消耗一个序号**

**第三步，客户端发送针对TCP服务器确认的确认，ACK=1，seq=x+1，ack=y+1，这是一个普通的报文段，如果不携带数据不消耗序号，下一个序号从x+1开始!!!这时TCP服务器才进入连接已建立阶段**

**为什么不用两次握手？**(面试常考)

![image-20230624192151599](https://img-blog.csdnimg.cn/e5fe90c896304955b4b7c9f8939ace2c.png)

浪费资源，同时

![image-20230625173604484](https://img-blog.csdnimg.cn/c796ce26efdf465ba1a387fc3ec32582.png)

<img src="https://img-blog.csdnimg.cn/dbed03246d434695a0a2c48dc0b4135b.png" alt="image-20230622150704074" style="zoom:80%;" />

* 用户发送TCP **SYN 报文段到服务器**

  * **客户机TCP向服务器的TCP发送请求连接的报文段**

    **这个报文段置同步位SYN为1，同时指定一个初始的序号 seq = x**

    **TCP规定，SYN不能携带数据，并且要消耗掉一个序号**

  * 指定初始的序号

  * 没有数据

* 服务器接收SYN，**回复SYN/ACK报文段**

  * 如同意建立连接，则向客户机发回确认，并为该TCP连接分配**缓存和变量**。

    在确认报文段中，把**SYN位和ACK位都置1** ， **确认号是 ack=x +1** ，

    同时也为自己选择一个**初始序号 scq=y** 。 注 意 ， **确认报文段不能携带数据，但也要消耗掉一个序号**

  * 服务器分配缓冲区和变量

  * 指定服务器的初始序号

* 客户接收SYN/ACK，回复ACK报文段

  * 当客户机收到确认报文段后，还要向服务器给出确 认，并为该TCP连接**分配缓存和变量** 。

    确认报文段的**ACK位置1**，**确认号 ack=y+1** ，**序号seq=x+1**。

    **该报文段可以携带数据， 若不携带数据则不消耗序号**

  * 可能包含数据

  ![image-20230611144616017](https://img-blog.csdnimg.cn/ae8b96c627064e2c819bee65076c1d26.png)


### TCP释放连接：四次挥手

![image-20230624192947356](https://img-blog.csdnimg.cn/a047c8ef65624b089d0731f59f298a3d.png)

**第一步，TCP客户端向服务器发送终止报文，FIN=1，ACK=1,seq=u,ack=v，seq和ack针对上一次发送和接受的数据进行设置**

**TCP规定FIN=1的终止报文段即使不携带数据也要消耗一个序号**

**第二步，TCP服务器向客户端发送普通确认报文，ACK=1，seq=v，ack=u+1，seq和ack由上一条得出**

**这样TCP客户到服务器单方向的传送就关闭了**

**第三步，TCP服务器还可能进行一些数据传输，最后发送终止报文，FIN=1,ACK=1，seq=w，ack=u+1,w是根据自己这边数据传输得出的，u+1是因为客户端没有发送报文了，这是对u前面的重复确认**

**第四步，TCP客户端发送普通的确认报文，ACK=1,seq=u+1,ack=w+1**

注意一点：Tcp发送确认报文之后还要经过2MSL才会完全关闭，下面探讨为什么

**如果最后一个报文段丢失了那么会导致服务器一直重发这条报文，所以需要设置一段等待时间**

![image-20230624193652490](https://img-blog.csdnimg.cn/44b8d629f7b14374895f8ec863de9a14.png)

#### 保活计时器

![image-20230624194027145](https://img-blog.csdnimg.cn/446f2ca597424f5eab28a7e1b8a2c95e.png)

**TCP服务器为了避免TCP客户端出现问题而无法及时发送报文段，设置了一个保活计时器，每收到一个报文就重置一下该计时器**

**如果到了规定时间还未收到数据，那么TCP服务器进程会像TCP客户进程发送探测保温段，如果发送了很多(10)个仍无响应，则关闭连接**

<img src="https://img-blog.csdnimg.cn/02a9fe838876467c8815e14791a1745f.png" alt="image-20230622151317052" style="zoom:80%;" />

* **客户关闭套接字: **clientSocket.close()

  Step 1: 客户发送 TCP **FIN 控制报文段到服务器**

  	该报文段的终止位 **FIN 置 1 ， 序 号 seq=u** ，它等于**前面已传送过的数据的最后一个字节的序号加1**，
  	
  	FIN报文段即使**不携带数据，也消耗掉一个序号**

  Step 2: 服务器接收 FIN, **回复 ACK. 进入半关闭连接状态**

  	**确认号ack=u+1 ， 序 号 seq=w** ， 等于它**前面已传送过的数据的最后一个字节的序号加1**
  	
  	此时，从客户机到服务器这个方向的连接就释放了

  Step 3: **服务器发送FIN**到客户，**客户接收 FIN, 回复 ACK**

  进入 “time wait”状态等待结束时释放连接资源

  Step 4: **服务器接收 ACK. 连接关闭**.

  <img src="https://img-blog.csdnimg.cn/73e274b031014204b0b5f0eb9f40439c.png" alt="image-20230611144918305" style="zoom:80%;" />

![image-20230611145144608](https://img-blog.csdnimg.cn/70f5cd4954f9475289dd11b79fbeab59.png)

### 拥塞控制

![image-20230624164440408](https://img-blog.csdnimg.cn/b7208624048944e0aa60ae3597f65e27.png)

拥塞控制是指**防止过多的数据注入网络**，**保证网络中的路由器或链路不至于过载**

拥塞控制和流量控制的区别：

拥塞控制是让**网络能够承受现有的网络负荷**，是一个全局性的过程，涉及所有的主机、所有的路由器，以及与降低网络传输性能有关的所有因素。强调全局

相反，流量控制往往是指点对点的通信量的控制，是个端到端的问题（接收端控制发送端），它所要做的是**抑制发送端发送数据的速率**，**以便使接收端来得及接收**。强调点对点

* 术语

  * **MSS：最大报文段**
  * rwnd：拥塞控制窗口
  * **ssthresh：满开始门限**

* 拥塞：

  * 从信息系角度：**太多源主机发送太多的数据**，速度太快以至于网络来不及处理

  * 与流量控制不同

  * 表现:

    **丢失分组** (路由器的缓冲区溢出)

    **长延迟** (在路由器的缓冲区排队)

控制方法

* 端到端拥塞控制
  * **没有从网络中得到明确的反馈**
  * 从**端系统观察到的丢失和延迟推断出拥塞**
  * TCP采用的方法
* 网络辅助的拥塞控制
  * 路由器给端系统提供反馈
  * 单bit指示拥塞 (SNA, DECnet, TCP/IP ECN, ATM)
  * 指明发送者应该发送的速率

#### TCP拥塞控制

![image-20230611150227235](https://img-blog.csdnimg.cn/133f517b9cd142119742060d75f24909.png)

* 三个机制
  * 慢启动
  * AIMD
  * 对拥塞事件做出反应

归纳

**只要网络没有出现拥塞，拥塞窗口就可以再大一些；只要出现拥塞，就减少一些**

**判断是否出现网络拥塞：没有及时收到按时到达的确认报文(发生超时重传)**

**发送方将拥塞窗口作为发送窗口**

![image-20230624164700775](https://img-blog.csdnimg.cn/ab99c4867d1f48249b8fd49ca7cd7dec.png)

##### 慢启动

**提前设置一个慢开始门限值，这里是16，然后采用指数的形式上涨，每次增加一倍；初值为1**

![image-20230624165034674](https://img-blog.csdnimg.cn/5d230a41f6034ef0b562d1c554c7aff9.png)

* **连接开始时，CongWin=1MSS**
  * **以2的指数方式增加速率**![image-20230611150506930](https://img-blog.csdnimg.cn/8a38e723bade4d3497b021f1339995c8.png)
* ![image-20230611150944446](https://img-blog.csdnimg.cn/ee643dff45d944438d454e51b78975af.png)

##### 拥塞避免算法

**如果慢启动加倍后超过了门限值，那么发送窗口去门限值!!!**

**超过慢开始门限之后每次增加一倍了，而是固定的增加1**

![image-20230624165146364](https://img-blog.csdnimg.cn/5e9cb21869a94213aeff89d3c7712dd9.png)

**如果过程中丢失了几个报文，导致重传计时器超时，那么判断网络很可能出现了拥塞，那么如下操作：**

**更新门限值为当前拥塞窗口的一半，设置拥塞窗口为1，重新开始慢启动**

![image-20230624165440842](https://img-blog.csdnimg.cn/f68833b80175428b853b2561990b107c.png)

**每经过一个往返时延 RTT 就把发送方的拥塞窗口cwnd加1，而不是加倍**

使拥塞窗口cwnd按线性规律缓慢增长（即加法增大），这比慢开始算法的拥塞窗口增长速率要缓慢得多

##### 慢开始门限ssthresh

- **防止拥塞窗口cwnd增长过大引起网络拥塞，还需要设置慢开始门限ssthresh状态变量**
- **当cwnd < ssthresh时，使用慢开始算法**
- **当cwnd == ssthresh时，可以使用慢开始算法，也可以使用拥塞避免算法**
- **当cwnd > ssthresh时，使用拥塞避免算法**
- **无论使用哪种算法，只要发送方判断网络出现拥塞，就把慢开始门限ssthresh设置为出现拥塞时的发送方窗口值的一半，把拥塞窗口cwnd设置为1，执行慢开始算法**
- ![image-20230622154851864](https://img-blog.csdnimg.cn/132f32e7dd384f9ea7e0c10848d07219.png)

<img src="https://img-blog.csdnimg.cn/ec48d4957ad849f189dfdeb4da6cd12b.png" alt="image-20230611151642399" style="zoom: 67%;" />

##### 快速重传和快速恢复

![image-20230622160059642](https://img-blog.csdnimg.cn/26a82b94cbe74f09a04c21782c97339c.png)

上面的意思简单来说就是：当发送方连续收到**三个重复的 ACK 报文**时，直接重传对方尚未收到的报文段，而不必等待那个报文段设置的重传计时器超时

![image-20230622155932347](https://img-blog.csdnimg.cn/83ee385dad1b4216a60eb11c0d769f45.png)

快速重传

![image-20230624165850413](https://img-blog.csdnimg.cn/688d2ae12c4f4cd68d41c960b6d1eff5.png)

注意细节(大题考)

**确认M2的意思是：我现在确认了M2，我想要的是M3!!!**

**收到三个重复确认的时候就对相应的报文段立即重传，而不是等待计时器超时，超时了就可能认为网络拥塞，导致网络传输效率减慢**

![image-20230624170425939](https://img-blog.csdnimg.cn/168e1339a2064671ab96d9e7ad2a823d.png)

快恢复算法

**针对只是个别报文段进行丢失的情况，在收到三个重复确认的时候启动快恢复算法而不是慢启动算法**

**将慢开始门限和拥塞窗口都调为当前窗口的一半，开始拥塞避免算法；也有的把拥塞窗口调整为新的门限加3**

**做题时记得加上3!!!**

![image-20230624170813869](https://img-blog.csdnimg.cn/c7fd3c5329ae454fac7e275b57c02ec6.png)

##### 注意(快速恢复阶段受到重复的ACK)

![image-20230626211432664](https://img-blog.csdnimg.cn/9f6105b8e5fe45ae8f26a77c8f0a6fc9.png)

**(在三个重复ACK之后)这个时候调成发送窗口为门限值大小!!!!!**

![image-20230626163513696](https://img-blog.csdnimg.cn/099b2181077d48908b395c20b5b30eb2.png)

![image-20230626163521386](https://img-blog.csdnimg.cn/11236e52980745dca49de1d7698feb33.png)

#### 总结

![image-20230611151806393](https://img-blog.csdnimg.cn/ccfffd62135c4492b1b6ec1a5578efc7.png)

![image-20230611152335303](https://img-blog.csdnimg.cn/56ca9622ebd040838df3eb9577b667c5.png)

* 当 CongWin 低于阀值, 发送方处于慢启动阶段, 窗口指数增长.
* 当 CongWin 高于阀值, 发送方处于拥塞避免阶段, 窗口线性增长.
* 当三个重复的ACK 出现时,阀值置为CongWin/2 并且CongWin 置为阀值加上3个MSS并进入**快速恢复阶段**，此时**每收到一个重复的ACK拥塞窗口增加1MSS**，**如果收到新的ACK则拥塞窗口置成阀值**）.
* 当超时发生时 ，**阀值置为CongWin/2 并且CongWin 置为1 MSS.** 

# 第四章 网络层

![image-20230626213312835](https://img-blog.csdnimg.cn/19efd9e1b72d4c4a944c7b5a878c739b.png)

## 协议总览

![image-20230626164519671](https://img-blog.csdnimg.cn/f147cc3b9b194100a9db013da0be532d.png)

**可靠传输，面向连接(虚电路)；不可靠传输，无连接(数据报网络)**

![image-20230624202157507](https://img-blog.csdnimg.cn/07aaeda8e8674fc692588b3680c00810.png)

**通过TCP/IP协议栈的网际层来学习网络层的理论知识和技术**

![image-20230624202306581](https://img-blog.csdnimg.cn/e134b9b9c3564ddea87e9c568e109550.png)

## 概念

* 从发送方主机传输**报文段**到接收方主机
* 发送方主机封装**报文段**(segments)为**数据报(datagrams)**
* 接收方主机递交**报文段**给传输层
* 在**每个**主机、路由器上都需要**运行网络层协议**
* 路由器会检查通过它的所有**IP数据报头部字段**，然后根据目的的IP地址对数据报进行转发

### 两个主要的网络层功能

#### 转发**(forwarding)** (数据平面)(硬件实现)

* **将分组从路由器的输入端口转移到正确的路由器输出端口**

#### **路由**(routing)(控制平面)(软件实现)

* **确定分组从发送方传输到接收方(目的主机)所经过的路径(或路由)**
  * 路由算法
  * ![image-20230612084523965](https://img-blog.csdnimg.cn/505f8c12198a4747880f570b6055db01.png)
* 路由是端到端的路线。整体路线
* 转发是局部具体怎么走
* 两者的相互作用
* 你要先路由确定路径我才能根据路径进行转发
  * ![image-20230612084719972](https://img-blog.csdnimg.cn/1614e6440f4d42088e5b2a7ab9593ccd.png)
  * **路由算法**确定通过网络的**端到端路径**
  * 转发表确定**本路由器**上的**本地转发**

## 数据平面和控制平面

* **数据平面**

  * 本地的，每个**路由器自身的功能**

  * **决定抵达路由器输入端口的数据包如何转发到输出端口，进行路由器内部的数据报文从输入端口到输出端口的转发**

    

* 控制平面

  * **整个网络范围**
  * 决定数据报在**端到端路径上的路由器之间**如何路由
  * 两种控制平面的实现方式
    * 传统的路由算法![image-20230612085204688](https://img-blog.csdnimg.cn/28223e253dff46649ef307f92e1c5354.png)
    * 软件定义网络 SDN![image-20230612085222116](https://img-blog.csdnimg.cn/632e3505ad964eb3a69d7e04d721dce0.png)

##  虚电路和数据报网络

虚电路

**这个虚电路的建立是逻辑上的连接，和电路交换物理上的连接是不同的!!!**

![image-20230624202545848](https://img-blog.csdnimg.cn/473b43f3677840f4bf0361fa0d856a8f.png)

数据报网络

**采用这种设计，把可靠数据传输的实现交给了上层的运输层来实现，而网络层是负责存储转发数据报就ok了**

**网络的造价大大降低，运行方式灵活，能够适应多种应用**

![image-20230624202734313](https://img-blog.csdnimg.cn/e81a0cbf6881420080f2b018c7956717.png)

比较

![image-20230624202931326](https://img-blog.csdnimg.cn/0fe4aab15a6d4640ba213b584526e837.png)

* **数据报网络提供网络层的无连接服务**
* **虚电路网络提供网络层的连接服务**
* 任何网络中的网络层只**提供两种服务之一，不会同时提供**
* 传输层：**面向连接服务在网络边缘的端系统中实现**
* 网络层：**面向连接服务在端系统及网络核心的路由器中实现**

* 数据报网络特点![image-20230612090035382](https://img-blog.csdnimg.cn/44f46b9b9fab40aabef8f91de0963ecd.png)

### 数据报转发表

* 采用地址范围建立表项![image-20230612090205350](https://img-blog.csdnimg.cn/96a4ec1121124e8384daa3b8775137bd.png)
* 对于给定的目的地址，使用**最长地址前缀匹配**来完成输出端口的查找
  * ![image-20230612090312398](https://img-blog.csdnimg.cn/615b243fd8d9464fb18c128444904701.png)
  * 路由器**转发表只维持转发状态信息**
  * **转发表由选路算法修改；虚电路网络转发表随虚电路的建立和拆除更新**
  * 一个端系统发送给另一个端系统的**一批分组可能在网络中选择不同的路径，到达的顺序可能不一致**
* 数据报网络的特点
  * **网络层服务模型简单**
  * **端系统功能复杂**。**高层实现许多功能，如按序传送、可靠数据传输、拥塞控制和DNS名字解析等**
  * 带来的结果
    * 因特网**服务模型提供的服务保证最少**（可能没有！），对网络层的需求最小，使得互连使用各种不同**链路层技术的网络变得更加容易**
    * 许多应用都是在位于网络边缘的主机(服务器)上实现

## 路由器的工作原理

![image-20230623104401684](https://img-blog.csdnimg.cn/cbfba86ffa3c4d038f57a26edc9f1bc4.png)

### 结构及功能

* 两个核心功能
  * **运行路由算法/协议(OSPF,RIP,BGP)**
  * 将分组从路由器的**输入端传送到正确的输出链路**
* 路由器的体系结构
  * ![image-20230612091315440](https://img-blog.csdnimg.cn/168410628fb94930b0290ee549f5026c.png)

### 输入端功能

* **线路端接**模块
  * 将一条**物理链路端**接到**路由器的物理层**
* **数据链路处理**模块
  * 实现路由器的**数据链路层功能**
* **查找与转发**模块
  * 实现**查找与转发功能**，以便**分组通过路由器交换结构**转发到**适当的输出端口**
  * 确定将一个到达的分组**通过交换结构转发给哪个输出端口**。通过**查找转发表**实现，这里的转发表是存储在**输入端口的内存中**
  * 分布式交换
    * 选路处理器计算转发表，给每个输入端口存放一份转发表拷贝
    * 在每个输入端口本地作出交换决策，无需激活中央选路处理器
    * 可避免在路由器中某个单点产生转发处理瓶颈
    * 目的：**以线速完成输入端口的处理**
    * 排队：如果数据报到达输入端口的速度快于输入端口将数据报转发到交换结构的速度，就会发生排队
* ![image-20230612092020730](https://img-blog.csdnimg.cn/3fd6b925182f48338976b6d3946abb12.png)

### 三种交换结构![image-20230612093013485](https://img-blog.csdnimg.cn/a2d0c0f18830489cb4182cba3c987587.png)

* 经内存的交换结构

  * 输入端口与输出端口之间的交换**由CPU(选路处理器)控制完成**

  * 输入端口与输出端口类似I/O设备：

    * 当分组到达输入端口时，通过**中断**向选路处理器发出信号，将**分组拷贝到处理器内存**中；

    * 选路处理器根据分组中的目的地址查表找出适当的输出端口，将**该分组拷贝到输出端口的缓存**中

  * **交换速度受总线带宽的速度限制(每个分组穿过两次总线)**

    * 若总线带宽为每秒写入或读出**B个**分组，则总的转发吞吐量 (分组从输入端口被传送到输出端口的总速率)**小于B/2**
    * ![image-20230612093316557](https://img-blog.csdnimg.cn/f321ef6ffb7b454a99f0c457e470c799.png)

* 经总线的交换结构

  * 输入端口**通过一条共享总线将分组直接传送到输出端口**，不需要CPU选路处理器的干预
    * 每次**只能有一个分组**通过总线传送
    * 分组到达一个输入端口时，若总线正**忙**，会被暂时阻塞，在输入端口**排队**
    * 路由器交换带宽**受总线速率控制**

* 经交换矩阵的交换结构

  * **纵横式交换机**：*由2*n条总线组成，*n* 个输入端口与*n* 个输出端口连接

  * 到达输入端口的分组**沿水平总线**穿行，直至与所希望的输出端口的**垂直总线交叉点**

    * 若该条**垂直总线空闲**，则分组被**传送到输出端口**
    * 否则，该到达的分组被**阻塞**，必须在输入端口**排队**![image-20230612094206251](https://img-blog.csdnimg.cn/60d49eb1198a4a64b1e808d22df015ce.png)

  * 输出端口：

    * 取出存放在输出端口内存中的分组，并将其传输到输出链路上
    * 当交换结构将分组交付给**输出端口的速率超过输出链路速率**，就需要排队与缓存管理功能。当输出端口的缓冲区溢出时，就会出现延时和丢包![image-20230612094508801](https://img-blog.csdnimg.cn/f0ca9f1ff23a4e539907486d7ffa7aa8.png)

    ![image-20230612094520528](https://img-blog.csdnimg.cn/4eb2d73b7e4a4e0996639f8c25692317.png)

  * 输入端口排队![image-20230612094720975](https://img-blog.csdnimg.cn/115f5b6578df4875854246f4c2e1794b.png)

### 网络层转发分组的流程

相邻直接传，否则查表传，特定>到达>默认，否则出错

1、从数据报的首部提取目的主机的IP地址D，得出目的网络地址N

2、若网络N与此路由器直接相连，则把数据报直接交付给目的主机 D，这称为路由器的直接交付；否则是间接交付，执行步骤 3

3、若路由表中有目的地址为D的特定主机路由（对特定的目的主机指明一个特定的路由，通常是为了控制或测试网络，或出于安全考虑才采用的），

则把数据报传送给路由表中所指明的下一跳路由器；否则，执行步骤 4。

4、若路由表中有到达网络N的路由，则把数据报传送给路由表指明的下一跳路由器∶ 否则，执行步骤 5

5、路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器;否则， 执行步骤6

6、报告转发分组出错

## IP数据报

### 发送过程

**IP数据报发送可以直接发到本网络，也可以通过路由器转发到其他网络，如果发到本网络称作直接交付，发到其他网络称作间接交付；**

**IP数据报中包含源IP地址和目的IP地址，IP数据报到达路由器的位置，先检查首部看是否出错，如果出错发送ICMP差错报告报文，路由器查路由表，把目的地址和子网掩码相与，如果得到的目的网络不匹配，则查下一项；查到匹配的则根据吓一跳进行转发，如果查不到则丢弃并且给发送方返回信息**

**注意发送过程中源IP和目的IP地址是不变的，修改的是源MAC地址和目的MAC地址!!!**

![image-20230625090650029](https://img-blog.csdnimg.cn/dfb10ca397b24a95b1c8344d6757cd9a.png)

例题

**中继器和集线器工作在物理层，既不隔离冲突域也不隔离广播域**

**网桥和交换机(多端口网桥)工作在数据链路层，可以隔离冲突域，不能隔离广播域**

**路由器工作在网络层，既隔离冲突域，也隔离广播域**

![image-20230625091612689](https://img-blog.csdnimg.cn/15eff0ba11754a809f88fdfe25d12150.png)

例题

注意要配置好默认网关

![image-20230625091935015](https://img-blog.csdnimg.cn/4b0197b4484a454d99faa5fcdc8309d3.png)

### 首部

![image-20230625104050465](https://img-blog.csdnimg.cn/a2a5044450b74cddae2963e19919f72e.png)

#### 版本

![image-20230625104131427](https://img-blog.csdnimg.cn/dd5c832e073547f6a7830e49220d15d5.png)

#### 首部长度

![image-20230625104221458](https://img-blog.csdnimg.cn/8b41dbc045f64e35a6a2d3d912265fbc.png)

#### 区分服务

只有使用区分服务该字段才有作用，一般情况不使用

![image-20230625104308971](https://img-blog.csdnimg.cn/38af49a5ae7449aab60b235cccededc8.png)

#### 总长度

表示总长度(首部+数据载荷)

**IP数据报是16位，理论上的最大长度是2的16次方-1，65535**

**首部长度以四字节为单位，总长度以字节为单位!!!**

![image-20230625104431604](https://img-blog.csdnimg.cn/fc0ce46c0ccc4889974fd5ffdf6271bd.png)

#### 标识，标志，片偏移(用于IP数据报分片)

![image-20230625104601025](https://img-blog.csdnimg.cn/385ac57022464ac48d17b60f6a047587.png)

**标识：标识各个分片数据报同一个数据报分片下来的**

**标志：DF 1表示不允许分片，0表示允许**

		  **MF 1表示后面还有分片 0表示最后一个分片**
	
	     **保留位 必须置0**

**片偏移：指出分片数据包的数据载荷部分在原来的数据报上偏移了多少的位置，以8字节为单位(写的时候注意要除以8)，并且片偏移量必须为整数!!!**

![image-20230625104729522](https://img-blog.csdnimg.cn/cdb1bc27eda44f5989a57c0c91f4c1cc.png)

##### IP分片举例

![image-20230625110152268](https://img-blog.csdnimg.cn/bb6e3ded294e4d2aadc009db5edeb189.png)

![image-20230625110210150](https://img-blog.csdnimg.cn/292968484b914e4783f165e2af0464e8.png)

#### 生存时间TTL(与路由环路相关)

![image-20230625111000783](https://img-blog.csdnimg.cn/819765a388c749d6bd692fccf1936052.png)

举例：防止路由环路

![image-20230625111025162](https://img-blog.csdnimg.cn/ad9530dbe12f4e628816d1f98bbfdff1.png)

#### 协议(熟悉)

![image-20230625111137796](https://img-blog.csdnimg.cn/c0e5d11b53b9477c8d6d9df37da52c19.png)

#### 首部检验和(如何计算)

**IP只计算首部，tcp,udp需要包含首部和数据**

![image-20230626173204731](https://img-blog.csdnimg.cn/c33aa6ee22194512836922ff91a6cd30.png)

![image-20230625111418457](https://img-blog.csdnimg.cn/eb48aaf37bae47c9a30486d10264a62c.png)

#### IP地址

![image-20230625111509445](https://img-blog.csdnimg.cn/270e37e93914405192b93e321f6ad087.png)

### 例题

注意：

**1.首部+数据载荷 对应MTU，记得要加上首部!!!也就是数据链路层的数据部分最大值!!!**

**2.片偏移量是以8字节为单位，并且一定是整数，所以数据载荷部分记得取8的整数倍数!!!**

![image-20230625112306082](https://img-blog.csdnimg.cn/9d8980485c34433382a855612770f144.png)



#### 学校PPT所讲

![image-20230612094758546](https://img-blog.csdnimg.cn/8afce6b985a24bfc84205f33d5724583.png)

* 各功能
  * 版本号：4位。表示该IP数据报使用的IP协议版本。目前Internet中使用的主要是TCP/IP协议族中版本号为4的IP协议
  * 首部长度：4位。此域指出**整个报头的长度**（包括选项）
    * 该长度是以**32位二进制数为一个计数单位**的
    * **接收端**通过此域可以**计算出报头在何处结束及从何处开始读数据**
    * 普通IP数据报（没有任何选项）该字段的值是**5（即20个字节的长度）**
  * 服务类型（TOS、type of service）：8位。服务类型字段的8位分成了5个子域![image-20230612095340972](https://img-blog.csdnimg.cn/6703de23613d49d4954b4866d37acda5.png)
  * 长度：16位。总长度字段是指**整个IP数据报的长度（报头区+数据区）**，以字节位单位
    * 利用头部长度字段和总长度字段就可以计算出IP数据报中**数据内容的起始位置和长度**
  * 生存时间(寿命 TTL，time to live)：占用8位二进制位
    * 指定了数据报可以在网络中传输的最长时间
    * TTL的初始值由源主机设置（通常为32、64、128或256），一旦经过一个处理它的路由器，它的值就减1。当该字段为0时，数据报就丢弃，并发送**ICMP**报文通知源主机，因此可以防止进入一个循环回路时，数据报无休止地传输下去
  * 高层：占用8位二进制位
    * IP协议可以承载各种上层协议，目标端根据协议标识就可以把收到的IP数据报送到**TCP或UDP**等处理此报文的上层协议了
  * 首部检查和
    * 占用16位二进制数
      * 用于协议**头数据有效性**的校验
      * 保证IP**报头区在传输时的正确性和完整性**。头部检验和字段是根据IP协议头计算出的检验和，它**不对头部后面的数据进行计算**
      * 原理：发送端首先将**检验和字段置0**，然后对头部中每16位二进制数进行**反码求和**的运算，并将结果存在校验和字段中。 由于接收方在计算过程中包含了发送方放在头部的校验和，因此，如果头部在传输过程中没有发生任何差错，那么**接收方计算的结果应该是全1**。
  * 源IP地址：占用32位二进制数，表示发送端IP地址
  * 目的地址：占用32位二进制数，表述目的端IP地址

##### 分片和重组

<img src="https://img-blog.csdnimg.cn/e45aa0b049bd499d81faf6c0aba06f58.png" alt="image-20230622164525685" style="zoom:80%;" />

* 分片：
  * 把**一个数据报**为了适合网络传输而分**成多个数据报**的过程称为分片，被分片后的各个IP数据报可能**经过不同的路径**到达目标主机
  * 一个IP数据报在传输过程中可能被分片，也可能不被分片。如果被分片，分片后的IP数据报和原来没有分片的IP数据报结构是相同的，即**也是由IP头部和IP数据区两个部分组成**![image-20230612103347388](https://img-blog.csdnimg.cn/8990cb3363f84098a57ba8c84498f792.png)
  * 分片后的IP数据报，**数据区是原IP数据报数据区的一个连续部分**，头部是原IP数据报**头部的复制**，但与原来未分片的IP数据报头部有两点主要不同：**标志和片偏移 **
    * 标志：在IP数据报头部有一个叫标志的字段，用3位二进制数表示![image-20230612103822809](https://img-blog.csdnimg.cn/1f6a02a8357541f584176e41d172614e.png)
  * —片偏移：IP数据报被分片后，各片数据区在原来IP数据区中的位置用**13位片偏移来表示**。上图中分片1的偏移为0；分片2的偏移为600；分片3的偏移为1200实际在IP地址中,由于偏移是以**8个字节为单位**进行计算的,因而在IP数据报中分片1的偏移是0；分片2的偏移是75；分片3的偏移是150
* 重组
  * 当分了片的IP数据报到达最终目标主机时，目标主机对各分片进行组装，恢复成源主机发送时的IP数据报，这个过程叫做IP数据报的重组。
  * IP数据报头部中，**标识**用16位二进制数表示，它**唯一地标识主机发送的每一份数据报**
    * 在一个数据报被分片时，每个**分片仅把数据报“标识”字段的值原样复制一份**，所以一个数据报的所有分片具有相同的标识
  * 目标端主机重组数据报的原理:
    * 根据“**标识**”字段可以确定收到的分片属于原来哪个IP数据报
    * 根据“**标志**”字段的“**片未完MF**”子字段可以确定分片是不是最后一个分片
    * 根据“**偏移量**”字段可以确定分片在原数据报中的位置

![image-20230612110021542](https://img-blog.csdnimg.cn/e8e0359206ca443a983645d70226c392.png)

### ip地址

#### 概述

**IPV4地址就是给因特网上的每一台主机或者路由器的每一个接口分配一个全世界范围内唯一的32位bit的标识符**

![image-20230624203130971](https://img-blog.csdnimg.cn/3a6b4dc8b14f4e65a6f91e1ed30391f9.png)

#### 分类编制的IPV4

![image-20230624203408369](https://img-blog.csdnimg.cn/ffebe7e51aa646e0a4fb41ba5e274fdc.png)

##### D类多播地址

<img src="https://img-blog.csdnimg.cn/8dbfb93d405a40458d4c26163ad91655.png" alt="image-20230624211609006" style="zoom: 80%;" />

![image-20230624211240221](https://img-blog.csdnimg.cn/bcf9e972ff1b4318b68afb3379da724a.png)

##### A类

![image-20230624203621544](https://img-blog.csdnimg.cn/a487189e1e404bf7b92863ba1f422c96.png)

##### B类

![image-20230624203836527](https://img-blog.csdnimg.cn/9f754073bd7044ffac33a905f0f7d403.png)

##### C类

![image-20230624203952543](https://img-blog.csdnimg.cn/107ca558129446e9a287322b97050879.png)

##### 特殊IP地址

![image-20230624204059658](https://img-blog.csdnimg.cn/7299c829be7841268acac9d160060f60.png)

![image-20230612110124002](https://img-blog.csdnimg.cn/3afd9f71f9fb4d18b6d8b56a59367068.png)

* IPV4编址

  * ![image-20230612110205717](https://img-blog.csdnimg.cn/1d7cab879d3544bba889565ee4121f74.png)

  * ![image-20230612110226430](https://img-blog.csdnimg.cn/08b6b2bd38ec4ba0ae9ee462da717bf5.png)

    * 分为主机号和网络号

  * 传统的IP地址分类![image-20230612110306612](https://img-blog.csdnimg.cn/a9e6ee897c6d41129973c3ea11e0a25d.png)

    * A类地址：第一个字节作为网络地址，**最高位为0**，其余的三个字节作为主机地址。![image-20230612110425765](https://img-blog.csdnimg.cn/594e8d0727e44004ac3777b4d91a3cd5.png)

    * B类地址：l两个字节作为网络地址，**最高位为10**，其余的两个字节作为主机地址![image-20230612110524582](https://img-blog.csdnimg.cn/aab473b4aefe41e3960b63fa687e5317.png)

    * C类地址：利用IP地址的前三个字节作为网络地址，最高位为110，最后一个字节作为主机地址![image-20230612110540514](https://img-blog.csdnimg.cn/c1018b2375bd4c229ee05d1e516586f4.png)

    * 特殊IP地址段![image-20230612110614270](https://img-blog.csdnimg.cn/727a620cca8b4bbda1994d8bbd56eae5.png)

      ![image-20230612110744135](https://img-blog.csdnimg.cn/d6a4adb9bd5144b08588777532813bb1.png)

    * 同一局域网上的主机或路由器的IP地址中的网络号必须相同

    * **交换机互连的网络仍然是一个局域网**，只能有一个网络号

    * 路由器总是具有两个或两个以上IP地址

    * 当两个路由器直接相连时，在连线两端的接口处，可以指明IP地址也可以不指明IP地址

#### 划分子网的IPV4

**为什么要划分子网呢？**

**如果不划分子网，那么对于新的主机网络，就需要构建新的网络，申请新的网络号，如下弊端：**

![image-20230624204819614](https://img-blog.csdnimg.cn/0c507671cf7d4b0593873161124df651.png)

**用子网掩码可以表示借用了多少位主机号来充当子网号**

![image-20230624204712748](https://img-blog.csdnimg.cn/405603f5ac6f45bba145a40561881bce.png)

##### 例题

![image-20230624205143265](https://img-blog.csdnimg.cn/cef8fa6c11b543008b40a6200eb473f2.png)

![image-20230624205227085](https://img-blog.csdnimg.cn/a589a22d29df4873aa2bc93c995f90b9.png)

##### 子网号能否为全0或者全1

**在 ABC类 划分子网时，子网号不能为全0或全1
在 CIDR 划分子网时，子网号可以为全0或全1**

![image-20230624205428971](https://img-blog.csdnimg.cn/22d37de437a64856a8e4b9712817d246.png)

![image-20230624205436720](https://img-blog.csdnimg.cn/bd10f90b14e0489cbdf6fd4240372420.png)

##### 默认子网掩码

主机号不管划不划分，讲子网号和主机号全取0

![image-20230624205935497](https://img-blog.csdnimg.cn/a96e091721294a6ca629a35929b682fe.png)

#### 无分类编制的IPV4(CIDR)

##### 表示方法

![image-20230624210214522](https://img-blog.csdnimg.cn/d00a21cbb8d044a19f0c7c7a1c3f2991.png)

举例

**聚合C类网的数量是指这个地址块相当于多少个C类网络的数量**

**C类网络主机号8位，因此12-8，留出4位当子网号，就是2的4次方**

![image-20230624210645096](https://img-blog.csdnimg.cn/650f90615644435dadfc5780ff98c2bf.png)

##### 路由聚合(构造超网)

**减少路由表的占用，对R1的5条路由信息合成一条！**

**寻找共同的前缀，作为新的IP地址的网络前缀，然后主机号取0就得到了这个目的网络号**

**值得主要注意的是，如果出现了多个匹配项，选择网络前缀最长的那个，称为最长前缀匹配。这样的路由更加具体**

![image-20230624211713812](https://img-blog.csdnimg.cn/a2c7aae994ba4b1b9e2b2492d1c6d5e6.png)

##### 例题

![image-20230624212025339](https://img-blog.csdnimg.cn/726f896cb8154d4e97beacf5fe90ed1a.png)

![image-20230624212055969](https://img-blog.csdnimg.cn/bf36180e55c64d90b4e7026534971d34.png)

#### IP地址的应用规划

##### 定长的子网掩码

![image-20230625084304792](https://img-blog.csdnimg.cn/5c5cd237ee2945be83c6a23a2ddc3749.png)

**注意看题目给出的是主机还是总的IP地址需求个数，记得根据情况是否加上网络地址，广播地址和路由器接口地址!!!!**

**注意，这些合计的IP地址数都是主机号决定的，而对于分类编址的IPV4的子网号不能取同0和同1，这个和这些没关系**

**注意，分类编址子网号不能全0和全1，CIDR是可以全0和全1的**

![image-20230625084912251](https://img-blog.csdnimg.cn/f0603b549acc4a06b13563f8d3ad4d87.png)

##### 变长的子网掩码(CIDR重点)

![image-20230625085219751](https://img-blog.csdnimg.cn/dbb0a71b7a51418390fcf02009081708.png)

**注意分配原则：每个子块的起点位置不能随意选取，只能选取块大小整数倍的地址作为起点，建议从大的子块开始分配!!!**

**注意这里的子网所需地址数量普通情况下是大于主机数量+网络地址+广播地址+路由器接口地址，但是我们划分子网主机号位数得出的子网地址数是2的n次方倍，这样虽然划分的子网中有地址浪费，但是大大减小了；并且也能选取块大小整数倍的地址为起点**

![image-20230625085535320](https://img-blog.csdnimg.cn/bbf47974393b4b008af3a8ba34ff8ff8.png)

#### 子网划分老师所讲

##### 划分子网

![image-20230612111124320](https://img-blog.csdnimg.cn/aa9d8f1b5cdb46be89aed630d7b3b8df.png)

* 划分子网的方法是**从主机号借用若干个比特作为子网号**，剩下的主机位为主机号
* 子网特点：
  * 设备接口的**IP地址具有同样的网络部分**
  * 没有路由器的介入，**物理上能够相互到达**
* 子网掩码
  * l子网号字段长度是可变的，因此，为了确定子网地址，IP协议提供了子网掩码的概念 。
  * l子网掩码用来**确定网络地址（包括网络号和子网号）**和**主机地址的长度**。子网掩码长为**32位比特**，其中的**1对应于IP地址中的网络号和子网号**，而子网掩码中的**0对应于主机号**。![image-20230612111333291](https://img-blog.csdnimg.cn/72d3cec3296540a3bfeac29fb225a453.png)



##### 子网划分技术

* 主机号**全0的地址不能用**，它被用做表示该子网的**子网号**；主机号**全1的也不能用**，它用于**本子网的广播**。因此每个子网所能容纳的主机数是**2^N-2**，N是主机号位数![image-20230612111717314](https://img-blog.csdnimg.cn/fc1918e226084010bd1fcc82da3d7eec.png)



##### 无分类域间路由CIDR

* Classless Inter-Domain Routing，CIDR

* lCIDR消除了传统的A类、B类和C类地址的概念。

* 使用**斜线记法，**又称为CIDR记法来**区分网络前缀和主机号**，即在IP地址后面加上一个斜线“/”，**斜线后面用一个数字指定网络前缀的长度**。

* 构造超网![image-20230612113204774](https://img-blog.csdnimg.cn/848a9542011e4e07aa90b02b07541f5b.png)

* ![image-20230612112136182](https://img-blog.csdnimg.cn/3bd857ed6a21475093f67c369b8e70da.png)

* 层次寻址，路由聚合![image-20230612112424214](https://img-blog.csdnimg.cn/d3fc5fbb22ba4f739f3f7ab77c380acd.png)

* 练习：![image-20230612112459665](https://img-blog.csdnimg.cn/9d79e273cbb044dcb55e13b087c6b030.png)

  > （1）
  >
  > 以最多台数的部门（60台）为准，需要的最接近数为2^6=64，故要从最后个字节借8-6=2位，
  >
  > 子网分别为 202.1.1.0, 202.1.1.64, 202.1.1.128, 202.1.1.192，在这4个其中任选3个即可。掩码均为255.255.255.192。
  >
  > （2）
  >
  > 若以最多台数的部门（120台）为准，仅能分两个子网，无法满足。故应采用CIDR法：
  >
  > 首先以最小需求台数部门为准（60台），此时主机号位数需要6位（因为60=<2^6-2），则子网号位数为8-6=2位，然后将子网划分出来。此时和（1）一样；
  >
  > 接下来，部门2、3可以直接在4个子网中任选两个，部门1选剩下2个以满足120台的要求（但这两个子网要连续，以便用CIDR法合并之，做超网）。比如202.1.1.128、202.1.1.192分别给部门2、3，部门1用202.1.1.0、202.1.1.64。
  >
  > （3）最后将各部门IP段用CIDR超网形式描述，以便对外发布：
  >
  > 部门1：202.1.1.0/25; (注意含义：表示前25位是网络号，且最后一个字节最高位为0，后面7位是主机号)
  >
  > 部门2：202.1.1.128/26; (最后一个字节最高两位为10，后面6位是主机号)
  >
  > 部门3：202.1.1.192/26; (最后一个字节最高两位为11，后面6位是主机号)
  >
  > 
  >
  > 说明：将202.1.1.128、202.1.1.192给部门1，202.1.1.0、202.1.1.64分别给部门2、3亦可。此时答案为：
  >
  > 部门1：202.1.1.0/26; 
  >
  > 部门2：202.1.1.64/26;
  >
  > 部门3：202.1.1.128/25

## 静态路由配置

**静态路由是指网络管理员使用命令给路由器配置路由表**

**简单，开销小，但是不能适应网络拓扑的变化，一般只在小规模网络中使用**

![image-20230625092159370](https://img-blog.csdnimg.cn/bbe8e6e4727e45f3b186c309ce04771c.png)

静态路由配置：人为配置好

![image-20230625092419554](https://img-blog.csdnimg.cn/5a09619ea8d447afab7f013a8905f7cd.png)

**默认路由：0.0.0.0(或者0.0.0.0/0)，在其他的路由查不到的时候，就是默认走这里；网络前缀最短，路由最模糊**

**特定主机路由：给网络中的某个主机特定配置的一个路由，网络前缀最长，路由最具体**

**当有多个路由可选的时候，找最长前缀匹配的!!!**

![image-20230625092551946](https://img-blog.csdnimg.cn/cb656f9064fd41039f3b8340c6f4450a.png)

### 路由环路

**静态路由配置错误导致路由环路**

配置错误后，R2吓一跳给R3，R3查表又给R2，死循环

**IP首部设有生存时间TTL的字段，进入路由器后-1，若不为0则转发，否则丢弃，这样就很好的缓解了路由环路问题**

![image-20230625093020162](https://img-blog.csdnimg.cn/2c5f3f6919264b2c8251c44b308fe3a7.png)

**聚合路由中有不存在的网络导致路由环路**

**为了节省空间，R2的路由表将R1 0和2 接口连接的网络聚合成了一个聚合路由存在了R2的路由表中，R2发出目的网络地址192.168.2.0/24，查R2的路由表发现192.168.0.0/22前缀匹配，则转发到R1，R1则正确接受并且转发给目的网络；**

**好，但是实际上24位的网络前缀在22位的基础上可以衍生出4个网络，其中两个网络是图中的网络拓扑没有的，所以就容易出现下列问题**

**发送192.168.3.0/24，按照前缀匹配会发给R1，然后R1找不到，就会找默认路由，然后又回到R2了,形成环路**

**解决方法：针对这两个不存在的路由存储黑洞路由，下一跳设置为NULL**

![image-20230625093743207](https://img-blog.csdnimg.cn/2b71dc9808c94f5e9cde7cdc0758a7d8.png)

**网络故障导致路由环路**

最开始正常，然后出故障，R2不知道，仍发送到R1，然后这个时候出故障之后从路由表中删除这个信息，然后就找到了默认路由，导致环路

解决：在消除之后设置黑洞路由，网络恢复之后将路由表恢复或者禁用黑洞路由

![image-20230625095651756](https://img-blog.csdnimg.cn/ef0b050d33084cb1afb655bef3d5524e.png)

##  动态主机配置协议DHCP(应用层协议)

### DHCP发现(客户发)

**源IP：0.0.0.0，目的：255.255.255.255，因为不知道服务器地址所以广播**

**帧当中带有事务ID和客户的MAC地址**

![image-20230625145702923](https://img-blog.csdnimg.cn/58a164fbc8b6474baac8e83bfe9bd7b8.png)

### DHCP提供(服务器发)

**服务器收到后发送DHCP提供报文，源IP：自己服务器IP，目的IP：广播**

**帧当中带有事务ID，用来标识这个是刚才客户发送的DHCP报文的回复**

**还带有IP的配置信息，包括IP地址，子网源码，地址租期，默认网关，DNS服务器等等**

**注意使用该IP的时候需要用ARP协议保证该IP地址未被其他主机使用**

![image-20230625145800985](https://img-blog.csdnimg.cn/2eefc30f19d44a5e9b84db17152864c2.png)

### DHCP请求(客户发)

**客户收到DHCP提供报文后，选择一个服务器的报文，想用它为自己提供的IP，发送DHCP请求报文，目的地址仍为0.0.0.0，因为还未正式使用这个IP地址，目的地址为广播，这样就不用单独给每一个DHCP服务器发送我是否同意用你的IP地址了**

**帧当中包含事务ID，DHCP客户的MAC，DHCP给分配的IP地址和DHCP服务器的IP地址**

![image-20230625150053892](https://img-blog.csdnimg.cn/53bbceaa9c584f53a29a8adcddc140f2.png)

### DHCP确认(服务器发)

**这时候服务器1收到请求，如果同意则返回确认报文**

**注意客户收到后，IP地址仍需要用ARP协议检测是否被占用，如果在这个过程中有人捷足先登占用了，那么发送DHCP取消报文取消租约，并重新来过**

![image-20230625150431016](https://img-blog.csdnimg.cn/e0303fb442a045848fae78b1bb27e63b.png)

### 关于租用期和补充

![image-20230625150649095](https://img-blog.csdnimg.cn/d596677486f1428ea404e47c122eb0dc.png)

### 关于DHCP中继代理

**我们不愿意给每个网络都设置一个DHCP服务器，这样会导致DHCP服务器太多了**

**所以例如DHCP的发现报文，由于目的地址为全1，为广播地址，这样的地址一般情况下是不会被路由器转发的，但是就是要通过路由器转发才能被DHCP服务器接受**

**那么只需要在路由器中配置DHCP服务器的IP地址就好了，这个路由器也就成为了DHCP中继代理**

**这个时候广播到达路由器的DHCP发现报文就会被路由器存储并且单播转发给DHCP服务器了**

![image-20230625150823199](https://img-blog.csdnimg.cn/1b4c0adcb7c34dcd8f60e0f4aff198ed.png)

### 老师PPT所讲

用于给主机动态的分配IP地址，它提供了**即插即用的联网机制**，这种机制允许一台计算机加入新的网络和获取IP 地址，而不用手工参与

**DHCP是应用层协议，是基于UDP的**

* DHCP: Dynamic Host Configuration Protocol

  * 自动从一个DHCP服务器得到IP地址

* 工作过程![image-20230612114056091](https://img-blog.csdnimg.cn/b1a87da62d4a423cbb38c6fb9c9a8d3b.png)

  > * 1：DHCP **服务器被动打开 UDP 端口 67**，等待客户端发来的报文
  >
  > * 2：DHCP **客户从 UDP 端口 68**发送 DHCP **发现报文**，以便从DHCP服务器获得一个IP地址
  >
  > * 3：凡收到 DHCP 发现报文的 DHCP 服务器
  >
  >       **都发出 DHCP 提供报文**，因此 DHCP 客户
  >           
  >       可能**收到多个 DHCP 提供报文**。
  >
  > * 4：DHCP 客户从几个 DHCP 服务器中**选择**
  >
  >       **其中的一个，并向所选择的 DHCP 服务**
  >           
  >       **器发送 DHCP 请求报文**。
  >
  > * 5：被选择的 DHCP 服务器发送**确认报文**
  >
  >       DHCPACK，客户进入已绑定状态，并可
  >             
  >       开始使用得到的**临时 IP 地址**了。
  >
  > DHCP 客户现在要根据服务器提供的**租用期 T 设置两个计时器 T1 和 T2**，它们的超时时间分别是 **0.5T 和 0.875T**。当超时时间到就要请求更新租用期。
  >
  > * 6：租用期过了一半（T1 时间到），DHCP客户 发送
  >
  >       **请求报文 DHCPREQUEST** 要求**更新租用期**。
  >
  > * 7： DHCP 服务器若不同意，则发回否认报文DHCPNACK。这时 DHCP 客户必须**立即停止使用原来的 IP 地址，而必须重新申请 IP 地址**（回到步骤2）
  >
  > * 8： DHCP 服务器若同意，则发回确认报文DHCPACK。DHCP 客户得到了**新的租用期，重新设置计时器。** 
  >
  > * 若DHCP服务器不响应步骤6的请求报文DHCPREQUEST，则在租用期**过了 87.5%** 时，DHCP 客户必须**重新发送请求报文 DHCPREQUEST**（重复步骤6），然后又继续后面的步骤。

* 服务场景![image-20230612125040776](https://img-blog.csdnimg.cn/7ab0ae0087424751bde8583f42ebd1da.png)

* DHCP分配的不仅仅是IP地址，还可以分配

  * 客户的第一跳路由器的地址(**网关**)
  * DNS服务器的IP地址或域名
  * 子网掩码

* **DHCP是应用层协议，基于UDP**

## NAT网络地址转换

### 私有IP地址

![image-20230625142918846](https://img-blog.csdnimg.cn/c00f680224b943d28ac72e0ac551b626.png)

本地网络只能用于局域网内部通信而不能被路由器进行转发，进入到公网当中

![image-20230625142809627](https://img-blog.csdnimg.cn/e1117df9670b40859e5089f112caebe0.png)

### NAT过程

![image-20230625143139594](https://img-blog.csdnimg.cn/6547c2b013354d54b8845ca87f18d631.png)

![image-20230625143252508](https://img-blog.csdnimg.cn/f57bf7484ffb4243a50ad562dbfa9568.png)

**存在的问题：一个内网地址对应一个路由器上接口的外网地址，那么如果外网地址的数量不够的话会出问题**

![image-20230625143422526](https://img-blog.csdnimg.cn/8f6e4b07f4754d88b51a9ac610fed443.png)

### NAPT

**把多个公网IP的问题用运输层的端口号来解决了，公网IP地址是相同的，但是端口号不同，所代表的进程服务就不同**

![image-20230625143550830](https://img-blog.csdnimg.cn/43d3d99a1d8a45039887ddb27e9b0d78.png)

### 补充

**使用NAT不能让外网主机优先向内网主机发送请求，因为这会导致在NAT表里面找不到记录而失败**

![image-20230625143744475](https://img-blog.csdnimg.cn/8870fe102aad454a8f996eaa51a6e3b7.png)

**NAT对外网屏蔽了内网的IP地址**

![image-20230625144001558](https://img-blog.csdnimg.cn/8979e3bda7834567a6ab4a85d7e208b2.png)

* 使本地网络分组离开时具有同样的IP地址![image-20230612231154780](https://img-blog.csdnimg.cn/11b2ed244dc648598be600f61f138d0b.png)

* 执行NAT时路由器要求：
  * 外出的分组: **替换每个外出的分组的 (源IP 地址, 端口号) 为 (NAT IP 地址, 新端口号)** 
  * 远程客户/服务器用**(NAT IP地址, 新端口号)****作为目的**地来响应。
  * (在NAT转换表中)记录每个(源IP 地址, 端口号)到 (NAT IP地址, 新端口号) 转换配对
  * 进来的分组: **对每个进来的分组，用保存在NAT表中的对应的(源IP 地址, 端口号) 替换分组中的目的域 (NAT IP 地址, 新端口号）**
* 地址转换过程![image-20230612231710190](https://img-blog.csdnimg.cn/d81891af0d7549e88454770176afb9d5.png)



## 因特网控制报文协议ICMP

![image-20230625113527570](https://img-blog.csdnimg.cn/904a6995a1fe45c9a3beb7fd62e85c8c.png)

分为两种：**ICMP差错报文和ICMP询问报文**

### ICMP差错报文

分为五种

#### 终点不可达

![image-20230625113859562](https://img-blog.csdnimg.cn/da99404413d941639c0e1138f4e018fc.png)

#### 源点抑制

因为拥塞而丢弃

![image-20230625114026661](https://img-blog.csdnimg.cn/e445a5a07cbd477293d9a974d0c1a16f.png)

#### 时间超过

![image-20230625114153412](https://img-blog.csdnimg.cn/4361a3278c1a483ea42f87b2266915c5.png)

**当在规定时间内无法收取全部的数据报的时候也会发送ICMP差错报文(时间超过)来提醒发送方重发剩余的分片**

![image-20230625114253198](https://img-blog.csdnimg.cn/1f189e6e7c6a4a3cb1ff8f21ed5c8ab4.png)

#### 参数问题

检测到误码

![image-20230625114429240](https://img-blog.csdnimg.cn/0d2c58c4e36a4a498d55d0fab03e8c07.png)

#### 改变路由(重定向)

**H1默认网关是R1，但是H1发送给N2的报文最佳路径是经过R4，R1收到这个报文后发现不是最佳路径，于是发送ICMP差错报告(改变路由)，H1添加路由项，发送报文给N2不经过默认网关R1而是R4**

![image-20230625114527220](https://img-blog.csdnimg.cn/3e593619b6654f6f9b9c72e6d9d09b4a.png)

#### 不应发送差错报文的情况

![image-20230625114719621](https://img-blog.csdnimg.cn/cf5b8590f0b549c49705075e0f5a2b3c.png)

### ICMP询问报文

**回送请求和回答**

**时间戳请求和回答**

![image-20230625141910573](https://img-blog.csdnimg.cn/b480faad6a0d48a9a8092c4ae39f6588.png)

#### 应用

分组网间探测PING

![image-20230625142139330](https://img-blog.csdnimg.cn/5659440ec9054e2ca7c573fb7bd0dc67.png)

跟踪路由

![image-20230625142241615](https://img-blog.csdnimg.cn/419d8fdf18cc4e1b8495f433e9c87d18.png)

![image-20230625142315919](https://img-blog.csdnimg.cn/6469aee32669410ca7400aa49372759e.png)



### 学校PPT所讲

**ICMP 差错报告报文：向源主机报告差错：包括终点不可达、拥塞丢弃、时间超过**

用于目标主机或到目标主机路径上的路由器向源主机报告差错和异常情况

- 终点不可达。当路由器或主机不能交付数据报时，就向源点发送终点不可达报文
- 源点抑制。当路由器或主机由于拥塞而丢弃数据报时，就向源点发送源点抑制报文
- 时间超过。当路由器收到生存时间为零的数据报时，除丢弃该数据报外还要向源点发送时间超过报文

**不应发送 ICMP差错报告报文的几种情况如下**

- 对ICMP差错报告报文不再发送 ICMP 差错报告报文
- 第一个分片的数据报片的所有后续数据报片都不发送ICMP 差错报告报文
- 对具有组播地址的数据报都不发送 ICMP 差错报告报文

* Internet Control Message Protocol
* 用于**主机路由器之间**彼此**交流网络层信息**
  * 差错报告: 不可到达的主机, 网络,端口,协议
  * 请求/应答
* 位于IP之上
  * 因为ICMP消息是**装载在IP分组里的**

![image-20230612232317788](https://img-blog.csdnimg.cn/2f5cae021e344089bd8bfdf6a48968be.png)

## IPV6

**更大的IP地址空间，从32位升到了128位**

**支持即插即用(自动配置IP地址)**

**IPv6 首部长度必须是 8B的整数倍，而IPv4 首部是 4B 的整数倍，tcp首部也是4B的整数倍!!!**

**从根本上解决了IP 地址的耗尽问题**

* IPv6 数据报格式
  * **固定长度的 40 字节首部**
  * 不允许分片：**IPv6 只有在包的源结点才能分片，是端到端的，传输路径中的路由器不能分片**

### IPV6地址表示

* 冒号十六进制表示法
  * ![image-20230612232811674](https://img-blog.csdnimg.cn/24f3aa0ca83f4545bb10400d98dde571.png)

## ==选路算法==

* 路由算法确定了通过网络的**端到端路径**
* 转发表确定了在路由器上的本地转发

* 默认路由器：
  * 与**主机直接相连的路由器**，又叫**第一跳路由器**
  * 每当主机发送一个分组时，都先传送给它的默认路由器
    * *源路由器：*源主机的默认路由器
    * *目的路由器：*目的主机的默认路由器
    * 从源主机到目的主机的选路归结为从源路由器到目的路由器的选路
  * **路由算法**：是确定一个分组**从源路由器到目的路由器所经路径的算法**
  * ![image-20230612233433762](https://img-blog.csdnimg.cn/4adb850ec45d4a9bafae3cb20770c059.png)

### 网络的抽象图模型：费用(cost)

![image-20230612233807967](https://img-blog.csdnimg.cn/0aa667394d024e12b0ef67bc8d5e3b91.png)

### 路由算法分类：

#### 全局路由算法

* **所有路由器拥有完整的网络拓扑信息和链路费用信息。**

  **链路状态路由算法LS**：**必须知道网络中每条链路的费用**

#### 分布式路由算法

* 以迭代的、分布式的方式计算最低费用路径
  * 节点只有**与其直接相连链路的费用信息**：**不需拥有**所有网络链路费用的完整信息
  * 通过迭代计算，并与相邻节点(邻居节点)交换信息
  * 逐步计算出到达某目的节点或一组目的节点的最低费用路径
* **距离向量路由算法DV**：每个节点维护到**网络中所有其他节点的费用**（距离）的估计向量

#### **静态路由算法**

* 路由确定后基本不再变化。只有人工干预调整时，可能有一些变化

#### 动态路由算法

* 网络的流量负载或拓扑发生变化时，**路径可能发生改变**
* 可以周期性地或直接地响应拓扑或链路费用的变化
* 易受选路循环、路由振荡之类问题的影响

![image-20230623103438337](https://img-blog.csdnimg.cn/afe74683b3d44540b6575e66a6ee2b27.png)

### 链路状态路由算法LS

#### Dijkstra最低费用路径算法

所有节点都知道网络拓扑，以及每条线路的信息

- 通过链路状态广播来实现
- 所有节点拥有相同的信息

- 计算**任意一个节点**（源节点）到**所有其他节点的最低费用路径**

* 给出该节点的转发表

* 迭代：通过k次迭代后可以知道到达k个目的节点的最低费用路径
* 基本思想：
  * 以源节点为起点，**每次找出一个到源节点的费用最低的节点**，直到把所有的目的节点都找到为止![image-20230613190712563](https://img-blog.csdnimg.cn/7b700d18580b435292ca0b9c2ad59948.png)
* 算法描述：![image-20230613191020488](https://img-blog.csdnimg.cn/5edbed363b7b47b48122d67c1803af8c.png)
  * 1、初始化
  * 2、找出一个到源节点的费用最低的节点w，并以此**更新其它点**D(v) 值
  * 3、重复步骤2
    * 直到所有的网络结点都在N'中为止

##### 例题

eg：

* 计算从*u*到所有可能目的节点的最低费用路径。

* 计算过程如表，表中的每一行表示一次迭代结束时的算法变量值。![image-20230613192048469](https://img-blog.csdnimg.cn/3b27337b737443629da1c4c7bf8e65d0.png)

* ==构建从源节点到所有目的节点的路径==
  * 对于每个节点，都得到**从源节点沿着它的最低费用路径的前驱节点**
  * 每个前驱节点，又可得到它的前驱节点；以此继续，可以得到到所有目的节点的完整路径![image-20230613192253768](https://img-blog.csdnimg.cn/3ee6a852efe743b98cab214be64891f6.png)
* ==构建最低费用路径树==
  * 根据**目的节点找出顺序和其费用以及前驱节点**，可以画出源节点u到所有目的节点的最低费用路径树
  * 根据得到的所有目的节点的**完整路径**，或最低费用路径树，可以生成源节点的**转发表**
  * 转发表
    * 存放从源节点到每个目的节点的最低费用**路径上的下一跳节点**
    * 即指出对于发往某个目的节点的分组，**从该节点发出后的下一个节点![image-20230613193259127](https://img-blog.csdnimg.cn/b45fd1227a67475a987064f3e1a17f5f.png)**

##### 转发表

* 构建转发表![image-20230613193624053](https://img-blog.csdnimg.cn/2026ccc83f194ed18c9eeea74139c961.png)

##### dijkstra复杂度

![image-20230613193847066](https://img-blog.csdnimg.cn/8acde222871447d29b2abb4c75da6969.png)

### 距离向量路由算法DV

* 距离向量路由算法是一种迭代的、异步的和分布式的算法
  * 分布式：每个节点都**从其直接相连邻居接收信息**，进行计算，再将计算结果**分发给邻居**
  * 迭代：计算过程**一直持续**到**邻居之间无更多信息交换为止**
  * 异步：不要求所有节点相互之间步伐一致地操作
  * 自我终结：算法能自行停止

#### 最低费用表示

![image-20230613194719897](https://img-blog.csdnimg.cn/2995e11fa6ce4098b6528b00e06fd87f.png)

* dx(y)：**节点x到节点y的最低费用路径的费用**
* v: 节点**x的邻居**节点
* c(x,v)+ dv(y)：x与某个邻居v之间的直接链路费用c(x,v)加上邻居v到y的最小费用。即**x经v到节点y的最小的路径费用**
* minv ：从所有经直接相连邻居节点到节点y的费用中选取的**最小路径费用**

* B-F方程举例![image-20230613194906607](https://img-blog.csdnimg.cn/eddb5453b9424110aa36ade2c2d8281f.png)
* 对每个结点x
  * 初始化
  * 更新自己的距离向量
  * 重复执行（2），直到没有更新的距离向量发出
  * ![image-20230613195434833](https://img-blog.csdnimg.cn/fc6e93d3789247858e499160ec955b02.png)

#### 距离向量表

* 行：该节点的距离向量Dx和其邻居的距离向量Dv

* 列：所有目的节点

* 节点x的距离向量Dx ，即节点x到每个目的节点y的估计费用； Dx = [Dx(y)：y在N中]

* 节点x每个邻居的距离向量Dv ，即x的邻居v到每个目的节点y的估计费用，Dv = [Dv(y)：y在N中]

* ![image-20230613195656072](https://img-blog.csdnimg.cn/f20baa17002a4c0797acc6b7dc503339.png)

* 更新其距离向量

  * ![image-20230613200022864](https://img-blog.csdnimg.cn/6dac94dde8734ca2a4da46e5edca3eff.png)

    ![image-20230613200539753](https://img-blog.csdnimg.cn/15d2a68bbc1a423d9bae073c3bb39a05.png)

#### 链路费用改变与链路故障

* 当一个节点检测到从它到邻居的链路费用发生变化时，就更新其距离向量，如果最低费用路径的费用发生变化，通知其邻居

* **某链路费用减少时情况**
  * ![image-20230613200702033](https://img-blog.csdnimg.cn/3b32e7b4d81f4c4392cee8725aa1b13a.png)
  * ![image-20230613200755966](https://img-blog.csdnimg.cn/4c658a9737274cc197f19dfcad9b2d72.png)
  * 好消息在链路中能迅速传播

* **某链路费用增加时情况**

  * ![image-20230613200830906](https://img-blog.csdnimg.cn/af50af847bd249b59a3dd68497fdb0b0.png)
  * ![image-20230613201428985](https://img-blog.csdnimg.cn/5811b2fd04d94729a8a49dc82bd6a015.png)
  * ![image-20230613201514443](https://img-blog.csdnimg.cn/bf8d39a8d516494b8ca18a45df32b61c.png)
  * 链路费用增加的“坏消息”传播很慢

  * ![image-20230613212521754](https://img-blog.csdnimg.cn/8ce1de33f6974500ac9e168b1dc6210a.png)

  * 不知道坏消息已经影响他了，局部形成环路

### LS算法与DV算法的比较

![image-20230613201606964](https://img-blog.csdnimg.cn/3223db81ad0b499ba1c7faf866d3e28e.png)

* LS算法：

  * 知道网络**每条链路的费用**，需发送O(nE)个报文；**当一条链路的费用变化时，必须通知所有节点**
  * 需要O(nE)个报文和O(n**2**)的搜寻，可能会振荡
  * 

* DV算法：

  * 迭代时，仅在**两个直接相连邻居之间交换报文**
  * 当链路费用改变时，只有**该链路相连的节点的最低费用路径发生改变时**，**才传播已改变的链路费用**
  * 收敛较慢。可能会遇到选路回环，或计数到无穷的问题。

* 健壮性

  * LS：
    * 路由器向其连接的一条链路广播不正确费用，路由计算基本独立（仅计算自己的转发表），**有一定健壮性**
  * DV：
    * 个节点可向任意或所有目的节点发布其不正确的最低费用路径，一个节点的计算值会传递给它的邻居，并间接地传递给邻居的邻居。**一个不正确的计算值会扩散到整个网络**
    * 无健壮性

## 分层次的路由选择协议

### 域内路由协议IGP

![image-20230623104007207](https://img-blog.csdnimg.cn/9ee4aed7fd0341baa1258e56f34de41f.png)

* 域（自治系统）内路由选择
* 内部网关协议 IGP ：AS(**自治系统**)内使用的 
  * RIP，OSPF
* 外部网关协议EGP：AS之间使用的
  * BGP 

#### 路由信息协议RIP(自治系统内部)

* 基于**距离向量**的路由选择协议

* 距离：**定义为路径中经过的路由器个数**

  * 通常为跳数，即从源端口到目的端口所经过的路由器个数，经过一个路由器跳数+1
  * **特别的，从一路由器到直接的网络距离为1**

* **RIP允许路由最多包含15个路由器**

  * **距离16表示不可达，而且就是用16来表示距离不可达到!!!!**
  * **RIP适用于小的互联网**

  等价负载平衡

  <img src="https://img-blog.csdnimg.cn/d227f21cc8fd498ab038a4afc1f26411.png" alt="image-20230623142700261" style="zoom:67%;" />

三个要点

- **和谁交换信息 和相邻的路由器**
- **交换什么信息 自己的路由表**
- **何时交换 周期性的交换**

##### 交换信息(路由表更新问题)

![image-20230623142336168](https://img-blog.csdnimg.cn/0d57855034134c25ac7acf5a7592f701.png)

注意这里有的资料认为距离相等但是下一跳不相等的时候不进行路由表更新，也就是图中的 N8 4 C 没有，这个看情况来定

* 仅和**相邻的路由器**交换信息
* 路由器交换的信息是**自己的路由表**
* ![image-20230613205209017](https://img-blog.csdnimg.cn/69a44e72095c40bfa2a7723019ebc40f.png)
* eg
  * 修改发来的路由更新信息，距离+1，下一跳路由器改为发送来的路由器
  * **更新距离**![image-20230613205506045](https://img-blog.csdnimg.cn/fb6c8fd4a3644d12ad63388c5dafa3c7.png)
* eg2：![image-20230613210112278](https://img-blog.csdnimg.cn/221e9cfab4314b978674bc2ec34edca3.png)

##### RIP存在“坏消息传的慢”的问题

**假如某一时刻R1收到N1故障，将自己的路由表修改为 N1 16 直连，然后到达周期时刻准备发给R2，然后R2这时候不知道，也发送给R1，但是R2的消息先到了，这个时候R1的消息尚未发出，收到R2的更新报文之后修改自己的路由表然后发出，这时候变为了 N1 3 R2，传过去R2变成了 N1 4 R1，以此类推，知道都更新为16的时候才知道不可到达，那么这个中间的过程就浪费了很长的时间，长达数分钟，形成了路由环路**

![image-20230623143244527](https://img-blog.csdnimg.cn/6a641db44643483397a4e49ceec1b8b0.png)

这些措施并不能彻底解决这个问题，根本上是距离向量算法决定的

#### 开放最短路径优先OSPF(自治系统内部)

**OSPF 信息直接通过 IP 传输 （不是 TCP 或 UDP），因此必须自己实现可靠报文传输、链路状态广播等功能。**

**为了克服RIP协议的缺点开发出来的，开放表示不是受某一家厂商控制而是公开发表的**

**OSPF基于链路状态，RIP基于距离向量**

* **使用了dijkstra最短路径算法**
* ![image-20230623144107129](https://img-blog.csdnimg.cn/5e85344147664f7487f8a35fb29ba9b3.png)

##### 交换信息

**OSPF相邻路由器之间通过Hello分组来建立和维护邻居关系**

![image-20230623144615721](https://img-blog.csdnimg.cn/01efa5b694434c3b8dffc62a14320709.png)

**每个路由器都有链路状态公告LSA**

![image-20230623144826717](https://img-blog.csdnimg.cn/fb0342262b7c4e968689d13183ae854c.png)

每个路由器都有一个链路状态数据库LSDB，用来存储每个数据库的LSA

![image-20230623144923675](https://img-blog.csdnimg.cn/85a009092fb14b209e434a9bffffa47a.png)

工作过程

![image-20230623144947654](https://img-blog.csdnimg.cn/156d47e570444dccab822606e59cd9e8.png)

五种分组类型

![image-20230623145048982](https://img-blog.csdnimg.cn/444ea8dc74ca41cc8255d8f71aab2742.png)

工作过程

![image-20230625103430164](https://img-blog.csdnimg.cn/a40b7dd7e7ff4576818af91b95e649bb.png)

**建立关系(指定路由器)**

**由于当链路状态更新的时候路由器需要通过广播的形式向系统中其他的路由器发送链路状态请求分组，所以在网络中就会存在大量的广播分组的传递，为了减少这个问题，引入了指定路由器DR和备用指定路由器BDR，规定其他的路由器只能和他们交换信息，减少了路由器之间相连的个数，但是增加了这两个路由器的负担**

![image-20230623145416672](https://img-blog.csdnimg.cn/8201f50b9e7143668d146e07d7b5ac22.png)

关于区域

将自治系统AS划分为若干个区域，为了减少区域内部的通信量，使得能用于大规模的网络系统

![image-20230623150007804](https://img-blog.csdnimg.cn/6f8132d214ba4265a2ba2d0aee78a52f.png)

* 通过洪泛法(广播)向自制系统内所有的路由器发送信息
  * **广播**
* 交换本路由器**相邻的所有路由器的链路状态**
* 当**链路状态发生变化时**交换信息![image-20230613210945337](https://img-blog.csdnimg.cn/33e00a490a1e4379830dff3baac89e12.png)

### 边界网关协议BGP(自治系统之间)

不同的自治系统之间所使用的代价度量可能不相同，**这使得在自治系统之间没有一个相对统一的标准**

**自治系统之间的路由选择必须考虑相关的策略，例如：政治，经济，安全等等**(比如有的自治系统不让我们的TCP报文通过)

**BGP协议为了找到一条尽可能快的路径(避免兜圈圈)，而不是找到最佳路径**

#### 工作原理

**BGP发言人之间通信需要建立TCP连接，端口号为179**

![image-20230623151542954](https://img-blog.csdnimg.cn/74427467eefd4132802d7a2700ad1069.png)

![image-20230623151716299](https://img-blog.csdnimg.cn/58c63dedcab140daae777f78352da036.png)

![image-20230613213119975](https://img-blog.csdnimg.cn/736414f37b3d4838aa1382ee68bd2ea8.png)

* 从相邻AS获取子网可达信息
* 向该AS内部的所有路由器传播这些可达性信息
* 域间寻路任务：![image-20230613213247279](https://img-blog.csdnimg.cn/0463a5189bd14247b2261eb853c56475.png)
* 基于距离矢量算法

### 三个封装关系

![image-20230623151144777](https://img-blog.csdnimg.cn/2a34c1d2ca3b4529a6043de65789b10d.png)

# 第五章 链路层

## 关于可靠数据传输

![image-20230626173103214](https://img-blog.csdnimg.cn/babfbe51ee4c4fd880de6cae269a3154.png)

地位

![image-20230623152241085](https://img-blog.csdnimg.cn/8e7609de84de4f5a9c3169ee4d5c3243.png)

**链路加上通信协议就称为数据链路**

![image-20230623152339948](https://img-blog.csdnimg.cn/9b90658f622041898004c50521861a11.png)

## 三个重要问题(点对点传输)

**封装成帧；差错检测；可靠传输**

封装成帧

**应用层封装好应用层协议数据单元，然后交付给运输层添加运输层协议首部，然后交给网络层添加网络层协议首部，然后交给数据链路层添加帧头帧尾，最后交给物理层把这一段帧视作比特流进行传输，到达接收方后进行一层一层的解包得到数据**

![image-20230623162156552](https://img-blog.csdnimg.cn/e343fb3c745a4911bef7b1ee01dc6eb5.png)

差错检测

![image-20230623162355842](https://img-blog.csdnimg.cn/e60599f1d57a40269e9296250913ce9c.png)

需要有一定的措施来判断传输过程的数据是否发生错误

可靠传输

![image-20230623162430886](https://img-blog.csdnimg.cn/892a5093f7b048e7a4a86753f5714fea.png)

尽管可能发生差错，但发送方发送什么，接收方都能相应的接受到什么，这个就叫做可靠传输

## 其他的

![image-20230623162729781](https://img-blog.csdnimg.cn/de86eadcf9e7404798264b4cc192cd82.png)

### 概述

* 主要术语

  * 链路层的节点包括了主机和路由器；
  * 我们将沿通信路径，将相邻节点连接起来的通信信道称为链路，这里的链路可以将主机与路由器，或者路由器与路由器连接起来。

  * 为了将一个数据报从源主机传输到目的主机，数据报必须通过沿端到端路径上的各段链路传输。

  * 链路主要包括：**有线链路和无线链路**。在实际链路上传输时，传输节点需要**将数据报封装成数据帧**进行传输。

  * 数据链路层的职责是将数据报从一个节点传送到与该节点**直接有物理链路相连**的另一个节点。

* 类比![image-20230614144243344](https://img-blog.csdnimg.cn/cee1bae540824027994ca39df6d69419.png)

* 链路层提供的服务

  * 封装成**帧**，链路接入
    * 封装数据报为数据帧，**增加头部尾部信息**
    * 若是共享链路，接入链路
    * 在**数据帧头部**中，用MAC地址来表示源目的MAC地址
      * 不同于IP地址
  * 在相邻节点之间**可靠传输数据帧**
  * 流量控制**(flow control):**
    * 用于控制发送节点向**直接相连的接收节点**发送**数据帧的频率**
  * 差错检测**(error detection):** 
    * 差错可能由信号衰减、噪声引入
    * 接收方检测是否出现错误
      * 通知发送方重传或丢弃数据帧
  * 错误纠正**(error correction):**
    * **接收方标识和纠正比特错误**，而不需要请求重传
  * **半双工和全双工(half-duplex and full-duplex):**
    * •在半双工模式，链路的两个节点都可以发送数据，但是不能同时发送

* 链路层实现的位置

  * 在主机和网络设备(路由器)上实现
  * 在主机上，链路层的主体部分是在**网络适配器**上实现的(称为**网卡**)![image-20230614145625597](https://img-blog.csdnimg.cn/3a888eaf97014c6b8b1a510173e60fe0.png)

## 封装成帧

![image-20230626213952332](https://img-blog.csdnimg.cn/49617752c4624f95ab671d57cc82c655.png)

**添加帧头和帧尾使之成为帧；包含重要的控制信息；帧头帧尾重要的作用之一就是帧定界**

![image-20230623163138611](https://img-blog.csdnimg.cn/e9b647bde76b450f87786646ce36cc18.png)

### 透明传输

透明传输是指数据链路层对上层交付的数据没有任何限制，就好像数据链路层不存在一样

**理解下来就是说：我的帧头帧尾里面的定界符是一串01，在数据当中很可能也存在一样的01，那么不加处理的话就会导致接收方把数据里面的01认为是定界符而导致数据出错。**怎么解决呢？

**面向字节的物理链路**，可以在数据当中的flag前面加上一个转义字符，表示这是数据不是定界符，接受方接收到之后把转义字符剔除就好了

![image-20230623163706309](https://img-blog.csdnimg.cn/3044c7fd37b54008bbf4de2484b0b21b.png)

如果数据中也包含转义字符形式的数据那么在前面也加上转义字符，接收方接受并且剔除就好了

![image-20230623164020644](https://img-blog.csdnimg.cn/ba17d254303441c5af90f3b3dab37759.png)

那么面向比特的物理链路呢？

**帧定界码：01111110**

**在数据当中的没五个连续的1后面加一个0，接收方接受识别并剔除就好了**

![image-20230623164150736](https://img-blog.csdnimg.cn/d3b67e0720c84df78694ff2081fbe6a6.png)

### 补充

帧数据部分尽可能大，提高利用率

**最大传送单元MTU**

![image-20230623164258204](https://img-blog.csdnimg.cn/a133b42d80a042619f63401a2e1b4db1.png)

## 差错检测和纠错

![image-20230614145803630](https://img-blog.csdnimg.cn/1adf68b30e4748ee8e231f2448c51caa.png)

* 发送节点![image-20230614145900470](https://img-blog.csdnimg.cn/8614ef8bd5704e949de6b16b5e1c5e12.png)

* 接收节点![image-20230614145955026](https://img-blog.csdnimg.cn/ea1ceef4fc2b469598f5eeeb3ccd57da.png)

* 差错检测和纠正技术不能保证接收方检测到所有的比特差错，即**可能出现未检测到的比特差错**，而接收方并未发现

  * 选择一个合适的差错检测方案使未检测到的情况发生的概率很小即可。

    差错检测和纠错技术越好，越复杂，开销更大

### 奇偶校验

**奇校验添加1保证1个数为奇数，如果1数量变为偶数就发生差错，但是如果1的奇性不变那么就无法检测出来，例如发生两位的误码**

![image-20230623164750694](https://img-blog.csdnimg.cn/61ff41b666af417fb235ef1553a95c4d.png)

* ![image-20230614150416870](https://img-blog.csdnimg.cn/78e0c996257045649ba00d0b06a66cc8.png)

* 二维奇偶校验![image-20230614150630833](https://img-blog.csdnimg.cn/8c7e7b3b20524830ae183df8cad4f6eb.png)

  ![image-20230614150919693](https://img-blog.csdnimg.cn/cc928c71873c4e4abc0deff057ff2a5f.png)

  > 第一行有3个1，因此第一行的校验位为1，
  >
  > 第二行有4个1，因此第二行的校验位为0，
  >
  > 第三行有3个1，因此第三行的校验位为1，
  >
  > 最终得到得到左边这个图。
  >
  > 假设在传输过程中，有一个比特错误，例如第二行第二列的1发生了翻转，变为了0，
  >
  > 在接收方进行检验时，会发现第二行的校验位不对，以及第二列的校验位不对，这样一交叉就会发现，第二行第二列的比特发生错误。
  >
  > 因此二维奇偶校验可以检测并纠正单个比特差错；能够检测分组中任意两个比特的差错。





### Internet校验和

![image-20230614151210888](https://img-blog.csdnimg.cn/f5c0d9aa9b474018adef9a54a2b41fd7.png)

> 在**发送方：**
>
> 首先，将数据的每两个字节当作一个16位的整数，可分成若干整数；
>
> 其次，将所有16 位的整数求和；
>
> 最后，对得到的和逐位取反，作为检查和，放在报文段首部，一起发送。
>
> 
>
> 在接收方：对接收到的信息 (包括检查和项)按与发送方相同的方法求和。
>
> 如果结果为全“1”：则收到的数据无差错；
>
> 如果结果中有“0”：则收到的数据出现差错。

* 特点：
  * 分组开销小，检查和位数比较少
  * 差错检测能力弱
  * 适用于**运输层**
  * 链路层的差错检测由适配器中专用的硬件实现，采用更强的CRC方法

### 循环冗余(CRC)检测

**算法要求多项式必须包含最低此项!!!**

![image-20230623165224195](https://img-blog.csdnimg.cn/d77a0e2c592845b1b9ad858ff46ce595.png)

* 即**多项式编码**，把要发送的比特串看作为**系数是0或1**的一个多项式，对比特串的操作看作为多项式运算

* 基本思想
  * 设发送节点要把数据*D*（*d* 比特）发送给接收节点
  * 发送方和接收方先共**同选定一个生成多项式G**（r+1比特），**最高有效位 (最左边)是1**。

> 把要发送的比特串看作为系数是0或1的一个多项式，对比特串的操作看作为多项式运算。
>
> 这里我们来看这样一个例子，10111这个比特序列，如果用多项式表示，每个比特作为多项式的系数，因此10111等价于x的4次方+x的2次方+x的1次方+1

* 基本思想![image-20230614151622292](https://img-blog.csdnimg.cn/4a5704041f1c4a30b9960a855f74d335.png)

  * 模2运算

    * 加法不进位，减法不借位![image-20230614152005675](https://img-blog.csdnimg.cn/da8d475d20284d7081819029b613c99a.png)

    * 乘以2*r*，即比特模式左移*r* 个位置。

          *D*×2*r* XOR *R* = *D* 00…00 XOR *R*
            
                       = *DR* (*d+r* 比特)·

  * > 如何计算CRC码。
    >
    > 首先将**数据D称为2的r次方**，这里r表示CRC编码的位数，
    >
    > 然后将其除以给定的生成多项式G，
    >
    > 所得的余数为CRC编码



* ![image-20230614152349294](https://img-blog.csdnimg.cn/b43ae8c3384c40a498f116a3979e5cf8.png)

  > 我们通过一个具体的例子来说明，CRC编码的计算过程。
  >
  > 假设数据D为101110，生成多项式G为1001，CRC编码为3比特，是生成多项式的位数减1.
  >
  > 这里用模2运输，计算CRC编码。
  >
  > 首先将D乘以2的3次方，即可得101110000；
  >
  > 然后将101110000除以生成多项式1001，最后可得余数为0011，因为CRC编码只取3比特，因此为011。
  >
  > 因此发送方最终发送的数据为101110011。

* 例题![image-20230614153203464](https://img-blog.csdnimg.cn/34707b76f7eb4028a900ce2c3568eed8.png)

* CRC特点

  * 生成多项式G的选择：常见的有8、12、16和32 比特生成多项式G
  * 能检测**小于 r+1 位的突发差错、任何奇数个差错**。![image-20230614153249181](https://img-blog.csdnimg.cn/0cb38340b9c34d41bc931de2bdac3fdb.png)

补充

![image-20230623165609117](https://img-blog.csdnimg.cn/0405c387023340279689954c33b8910d.png)

**注意：CRC具有纠错能力，但是数据链路层一般只用他的检错能力，关于纠错看第四条**

### 三种方法的比较

![image-20230614153536058](https://img-blog.csdnimg.cn/fe75ceaf6934419d9496ffc9391b567e.png)

## 多路访问链路和协议

![image-20230626213714390](https://img-blog.csdnimg.cn/2a4b8653c782494c8775f5eeb775d737.png)

![image-20230626192839443](https://img-blog.csdnimg.cn/d17ecebd6d6c4d7eab6e7ca4e1c5444d.png)

### 两种网络链路

* **点对点链路**
  * 链路两端各一个节点。一个发送和一个接收
  * 如点对点协议ppp
* **广播链路**
  * 多个节点连接到**一个共享的广播信道**
  * 广播：
    * **任何一个节点传输一帧**时，信号在信道上广播，**其他节点都可以收到一个拷贝**

### PPP(point to point protocol)协议（了解)

封装成帧，链路控制协议LCP，网络控制协议NCPs

![image-20230623170531731](https://img-blog.csdnimg.cn/1ee9a6b5785e488fa3a299bcc9045dd1.png)

#### 帧格式

![image-20230623171139140](https://img-blog.csdnimg.cn/b32da2a9b90b4ace88d7687d14dd958d.png)

![image-20230626191818698](https://img-blog.csdnimg.cn/1e3fc6120a7c484790b3047844d049fe.png)

#### 关于封装帧的透明传输

**面对字节：**

三种数据，定界符7E，转义字符7D和ASCII码控制符的处理

![image-20230623171454880](https://img-blog.csdnimg.cn/3f5ea02b46ba4dd2afdf54fa91bf5587.png)

**面对比特：**

![image-20230623171554940](https://img-blog.csdnimg.cn/518f31ee05b94d3ebf2a679f83bc9fd8.png)

#### 差错检测

计算范围如下，计算完之后填入FCS

![image-20230623171706985](https://img-blog.csdnimg.cn/bf62ef420015485ca46967b0fee72503.png)

### 广播信道

* ### 存在问题![image-20230614153847137](https://img-blog.csdnimg.cn/2702281f38bf482db86c2c66ffe77123.png)

## 多路访问协议

* 目的：
  * 避免多个节点同时使用信道，发生冲突，产生互相干扰
* 冲突（collide）：
  * **两个以上的节点同时传输帧**，使接收方收不到正确的帧(所有冲突的帧都受损失)
    * 造成广播信道时间的浪费
    * 多路访问协议可用于许多不同的网络环境，如有线和无线局域网、卫星网等

* 理想的多地址访问协议![image-20230614154953535](https://img-blog.csdnimg.cn/dbb47c93205942acb8578b4fc08b8251.png)



![image-20230614155005837](https://img-blog.csdnimg.cn/310a8951426046f188ef06281ce556f8.png)

### 信道划分(静态划分信道)协议

* 把信道划分为小片(时隙)
* 给节点分配专用的小片
* 主要有**TDMA、FDMA**、**CDMA**三种

#### TDMA时分复用

![image-20230623185937536](https://img-blog.csdnimg.cn/e039e232ee8d428799b411b77c298557.png)

* 设信道支持 *N* 个节点，传输速率是 *R* b/s

  * **时分多路访问**TDMA **(time division multiple access)**

    * 将时间划分为***时间帧***，每个时间帧再划分为***N个时隙***（长度保证发送一个分组），分别分配给*N*个节点。**每个节点只在固定分配的时隙中传输**。

          例：6个站点的LAN, 时隙1、3、4 有分组, 时隙2、5、6 空闲 

    ![image-20230614155414982](https://img-blog.csdnimg.cn/87fce655482140b1b1f797a427d91eff.png)

* 频率相同，每个用户占用不同时隙

* TDMA特点：

  * 避免冲突、公平
    * 每个节点专用速率R/N b/s
  * 节点速率有限：R/N b/s
  * 效率不高：节点必须等待它的传输时隙![image-20230614191733115](https://img-blog.csdnimg.cn/0e9ed4dffe5745b48a224dacf4b89025.png)





#### FDMA频分复用

**不同用户的数据使用不用的频率段**

![image-20230623185812721](https://img-blog.csdnimg.cn/10776a82b7624c32b29b2fd5cb71076c.png)

* **频分多路访问**FDMA **(frequency division multiple access)**
* ![image-20230614155848923](https://img-blog.csdnimg.cn/d2c82e95fa574949a14b948464fb82e8.png)
* 每个用户占一个频段 ![image-20230614191544047](https://img-blog.csdnimg.cn/26a2b6455feb4dfd9b21e6237c589be2.png)



#### CDMA码分复用

与前面两个不同，**码分复用允许用户在同样的时间使用同样的频带进行通信**

**由于各用户使用经过特殊挑选的不同码型，各用户之间不会造成干扰**

**每一个用户有标识性的唯一的编码，可以用这个编码对自己的数据进行编码然后进行发送**

* **码分多路访问**CDMA (code division multiple access)

* ![image-20230614155922455](https://img-blog.csdnimg.cn/a7c3ceac49d944889f4ed4144cf2e5c7.png)

  

### 随机访问协议

* 基本思想
  * 发送节点**以信道全部速率（*R* b/s）发送**
  * 发生冲突时，**冲突的每个节点分别等待一个随机时间**，再重发，**直到帧(分组)发送成功**
  * 节点间没有协调者
* 典型随机访问协议：
  * ALOHA协议(纯ALOHA，时隙ALOHA)
  * 载波监听多路访问CSMA协议
  * 带冲突检测的载波监听多路访问CSMA/CD
  * 带冲突避免的载波监听多路访问CSMA/CA

#### ALOHA

* ![image-20230614160323469](https://img-blog.csdnimg.cn/ea16ff4649d04e309fe83861edc86fa7.png)

> 首先介绍ALOHA协议。
>
> ALOHA是夏威夷大学研制的一个无线电广播通信网，采用星型拓扑结构，使**地理上分散的用户通过无线电来使用中心主机**。
>
> 中心主机通过下行信道向二级主机广播分组；
>
> 二级主机通过上行信道向中心主机发送分组（可能会冲突，无线电信道是一个公用信道）。如图所示。
>
> ALOHA有两种形式：时隙ALOHA和纯ALOHA。我们将分别进行介绍。

#### 纯ALOHA

* 非时隙ALOHA：简单，不需同步
* **帧一到达，立即传输**
* 如果与其他帧产生冲突，在该冲突帧传完之后：
  * **以概率p**立即重传该帧
  * **或等待一个帧的传输时间**，**再以概率p传输该帧**，或者**以概率1-p 等待另一个帧的时间**![image-20230614160542156](https://img-blog.csdnimg.cn/ec9618d3cdfd4a26ae2f40e384ff1bef.png)
* 纯ALOHA效率![image-20230614160701801](https://img-blog.csdnimg.cn/ddd130a86b634217a2eda7a250979415.png)
* ![image-20230614161434578](https://img-blog.csdnimg.cn/60dd338486064621a51d6fe2b9a76143.png)



#### 时隙ALOHA

* ![image-20230614190132600](https://img-blog.csdnimg.cn/1aa505c9132d46c49508501d725c7e3e.png)
* 控制发送的时间
* 比纯ALOHA效率更高



* 效率
  * 当有很多节点，每个节点有很多帧要发送时，成功时隙所占的百分比
  * ![image-20230614192321295](https://img-blog.csdnimg.cn/e8948b5426a5469c8cb4d72536361d6a.png)



### CSMA（载波侦听多路访问）

动态接入控制

协调总线上各个主机的工作，尽量避免产生碰撞，是我们要研究的问题

* 载波侦听

  * 某个节点在发送之前，先监听信道
  * 信道忙：有其他节点正往信道发送帧，该节点随机等待（回退）一段时间，然后再侦听信道
  * 信道空：该节点开始传输整个数据帧

* CSMA特点：

  * 发前监听，可减少冲突
  * 由于传播时延的存在，仍有可能出现冲突，并造成信道浪费

* CSMA发送冲突的例子

  * ![image-20230614192826190](https://img-blog.csdnimg.cn/c1373b1c95464c3986840795be085084.png)
  * ![image-20230614193028622](https://img-blog.csdnimg.cn/4e426fc5e821443b9e76a4128c0a01b2.png)

  > 在时间t0：节点B侦听到信道空，开始传输帧，沿着媒体传播比特。
  >
  > 在时间t1：节点D有帧要发送。B的传输信号未到达D，因此D检测到信道空，开始传输数据帧。很快，B的传输开始在D节点干扰D的传输（冲突）
  >
  > 我们可以看到传播时延越长，节点不能侦听到另一个节点已经开始传输的可能性越大。

* 带来的问题：信道浪费

  * **节点没有进行冲突检测**，既使发生了冲突，节点仍继续传输它们的帧。但**该帧已经被破坏、是无用的帧，信道传输时间被浪费**



#### 总线局域网协议 CSMA/CD

![image-20230626190818430](https://img-blog.csdnimg.cn/0cb673a6a2b24137adb68c1fd3effee2.png)

多址接入MA：多个主机连在一条总线上，竞争使用总线

载波监听CS：发送前检测是否有其他站点正在发送，有则等待(**96比特时间**)

碰撞检测CD：**发送的过程**中检测是否出现碰撞，有则停止发送，退避一段时间再次发送**（这个和发送完帧的传播不一样！发送完很有可能帧仍在传播)**

![image-20230623194111678](https://img-blog.csdnimg.cn/35481a236af94c8e9fdfa86cba33cb4f.png)

**载波监听多址接入/碰撞检测**

CS:载波侦听/监听，每一个站在发送数据之前以及发送数据时都要检查总线上是否有其他计算机在发送数据

MA：多点接入，表示许多计算机以多点接入的方式连接在一根总线上

CD：碰撞检测(冲突检测)，**边发送边监听**，判断自己在发送数据时其他站是否也在发送数据

* 基本原理：传送前侦听

  * 信道忙：延迟传送
  * 信道闲：传送整个帧

* 发送同时进行冲突检测：一旦检测到冲突就立即停止传输， 尽快重发

* 目的：缩短无效传送时间，提高信道的利用率

* CSMA/CD举例![image-20230614193518854](https://img-blog.csdnimg.cn/b12b3515961249da8a75abdd38469fd9.png)

  > 可以看到CSMA/CD中虽然也会发生碰撞，但是两个节点B、D在检测到冲突之后很短的时间内都放弃传输。
  >
  > （备注）
  >
  > 黄色表示B节点的传播物理范围，红色表示D节点的物理传播范围
  >
  > 怎么看时空图，横轴表示四个节点在空间中的位置，纵轴表示时间
  >
  > 在时刻t0，节点B侦听到信道是空闲的，因为当前没有其他节点在传输，于是节点B开始传输
  >
  > 在t1时刻，由于B节点的电磁波还没有传播到D能检测的范围，因此D节点发现信道空闲，开始传输，这个时候就会产生相互干扰
  >
  > D节点检测到干扰后，会**立即放弃**传输，B节点也会放弃

* 以太网CSMA/CD的运行机制

  > 我们说以太网也是采用CSMA/CD机制来访问共享信道。
  >
  > 其基本思想如下：
  >
  > 首先，适配器从网络层获得一个数据报，封装成帧，准备发送；
  >
  > 第二，如果适配器侦听到信道空闲，开始传输帧；如果检测到信道繁忙，将等待一段时间，直到侦听到信道空闲，开始传输帧；
  >
  > 第三，在传输过程中，适配器会同时监听是否有其他适配器的信号能量；
  >
  > 如果适配器在整个帧的传输过程中，没有监听到其他信号，则完成该帧的传输；如果监听到来自其他适配器的信号，则中止传输帧；
  >
  > 中止传输后，**适配器会等待一个随机时间**，重新执行步骤2

  * ![image-20230614193752692](https://img-blog.csdnimg.cn/07796e4c344d483da04995606555383d.png)

关于碰撞

![image-20230623194508839](https://img-blog.csdnimg.cn/4608e3558fe04a3191b6c5e27c2a4761.png)

##### 以太网CSMA/CD的运行机制讨论

* 拥塞信号

  * 48比特，确保所有传送者知道冲突发生

* 比特时间

  * •对于10 Mbps Ethernet 为0.1微秒，
    当K=1023，等待时间大约50毫秒

* 二进制指数回退算法

  * •目标：适配器依据当前负载情况重传，重负载时等待时间变长

    •第一次冲突： 在{0,1}中选k值；延迟Kx512比特时间传送

    •第二次冲突：在{0,1,2,3}中选k值…

    •10次以后，在 {0,1,2,3,4,…,1023}中选k值。

    •K是等概率选择

##### 争用期

* 最迟要多久才能检测到碰撞？![image-20230614200805416](https://img-blog.csdnimg.cn/42d53afacf7040e3be9de5b9bf05d912.png)

引入**争用期**的概念

**我们需要尽量做到的就是在数据发送完成之前，就是最后一个比特发送出去之前，我们的第一个比特已经到达目的主机了，如果帧太短没到达的话，这段信号就没有人监听了，意思是发生了碰撞也没人管**

![image-20230623194834497](https://img-blog.csdnimg.cn/ca88a19a6b1d4ef8b1a84b4ba130c27f.png)

##### 最小帧长

**如果发送的帧太短，那么发送帧的时间就很短，完了之后可能帧还没传到地方，这个时候并没有进行碰撞检测，所以这个时候发生碰撞就没有办法处理了**

![image-20230623195552335](https://img-blog.csdnimg.cn/9e0ac338fd154c2f83530b8eada529e8.png)

**如果接收方接收到的帧长度小于64字节，那么一定是发生了碰撞，这个数据为垃圾数据，应该直接丢弃**

**最小帧长 = 争用期 * 数据传输速率**

**这个是在传播时延和发送时延相同的极限情况下得出的，也就是第一个bit刚好传到然后最后一个bit刚好发送完的极限情况，保证了刚好在发送过程中能一直监听是否发生碰撞，免得发送完毕之后第一个字节还在传播就可能碰撞**

![image-20230623202304075](https://img-blog.csdnimg.cn/514351bda27141248b852d166fa9c16b.png)

##### 最大帧长

![image-20230623200424898](https://img-blog.csdnimg.cn/1f61001a01ee458d9f24b1594b45b06b.png)

##### 截断二进制指数规避算法

**用来计算发生碰撞之后的与下一次重传的退避(间隔时间)**

![image-20230623201225148](https://img-blog.csdnimg.cn/9f4882b33b2a4c71b0d381de14f52be9.png)

![image-20230614201158767](https://img-blog.csdnimg.cn/b673e34d2c1847f38e83563cb5669dd1.png)

##### 信道利用率

![image-20230623201513042](https://img-blog.csdnimg.cn/bf016dfb292d4904ad4a5b114d102c2e.png)

提高利用率：**以太网端到端的距离受到限制，以太网帧的长度应该尽可能长一些**

接受方的流程

需要通过三个检查：最短帧长；地址正确；CRC检测出现误码

![image-20230623201745152](https://img-blog.csdnimg.cn/390acd17a50c4a9c8f9c555bf7ea4fbe.png)

#### 无线局域网协议 CSMA/CA

CA：避免碰撞

**在无线局域网当中不能使用碰撞检测CD，应该使用碰撞避免CA！！！**

原因：

![image-20230623202908992](https://img-blog.csdnimg.cn/d09782325aa84a808f02568960b7c755.png)

* **可以适用于无线局域网**
  * 这是CSMA/CD无法实现的
* 工作原理
  * 预约信道
  * ACK帧
  * RTS/CTS帧

* 两者区别![image-20230614202226981](https://img-blog.csdnimg.cn/1abc40e516c94d0389bb3ab75838f24a.png)

### 介质访问控制协议

* MAC协议：
* ![image-20230614203131214](https://img-blog.csdnimg.cn/f105cdfca0e64a16b4212b5d7b3e983b.png)

#### 轮询协议

* 轮询开销
* 等待延迟
* 单点故障

![image-20230614203303160](https://img-blog.csdnimg.cn/966a16b77f6f49a483053531be6c575f.png)

#### 令牌传递协议

* 令牌：
  * 一个特殊格式的MAC控制帧，不含任何信息
  * 确保同一时刻只有一个节点独占信道
* ![image-20230614203552549](https://img-blog.csdnimg.cn/ff3d0fe33b29405abec2c374f66a7d5a.png)

## MAC地址，IP地址和ARP协议

![image-20230623203359379](https://img-blog.csdnimg.cn/224c93fbfc484ca28d72dec7ca825599.png)

### Mac地址介绍

**Mac地址又称为物理地址，用来全球性唯一标识网络接口，属于数据链路层，不属于物理层**

![image-20230623203746399](https://img-blog.csdnimg.cn/bee0e139a9e94b64b818e85b0e76a08d.png)

#### 单播，广播，多播MAC地址举例

![image-20230623204425170](https://img-blog.csdnimg.cn/b9d59657666a4ff59632bae364f7fb61.png)

![image-20230623204449724](https://img-blog.csdnimg.cn/5fde48ae9e8d4170b30edd472ae0b902.png)

**多播和广播的区别：多播是一对多，不一定是全部；而广播就是一对全部**

**判断是否为多播地址，多播地址的第一个字节的第一个bit是1，也就是图中的第二个数字是奇数，这里就是7**

![image-20230623204941223](https://img-blog.csdnimg.cn/0e9878fc24a04777adbab32147bfdd1d.png)

**给主机配置多播组列表进行私有应用时，不得使用公有的标准多播地址**

### IP地址

![image-20230623205811799](https://img-blog.csdnimg.cn/f61a6253588c477bb4680ef8835b5040.png)

数据的封装过程

![image-20230623210002716](https://img-blog.csdnimg.cn/a41da6fd70564fa3a1c3403de47d1672.png)

我看不懂也不需要看懂，加上首部(尾部)交给下一层

**在网络层首部中应该封装有源IP地址和目的IP地址；链路层首部中应该封装有源MAC地址和目的MAC地址**

#### 数据包转发过程中的IP和MAC

**在数据包的转发过程中，源IP地址和目的IP地址始终保持不变，而源MAC地址和目的MAC地址逐段链路(或逐个网络)改变！！**

![image-20230623210353555](https://img-blog.csdnimg.cn/a1c0a72e9cf44197b60cc85765e96456.png)

### ARP协议

**通过IP地址找到其对应的MAC地址**

**发送广播帧，目的MAC地址是全1(FF-FF-FF-FF-FF-FF)**

**对应的主机收到并且将发送方的IP和MAC存到自己的ARP缓存表中记录**

![image-20230623211704130](https://img-blog.csdnimg.cn/23d8ab5742004f10b92d9932a9627d7f.png)

**返回的帧源IP和MAC是自己的，目的是发送方的；发送方收到返回帧之后解析，得到MAC地址并且存到ARP缓存表中**

![image-20230623211851788](https://img-blog.csdnimg.cn/f617a4e368604b099d622dec6516384a.png)

**注意：ARP协议只能用于一个链路或者网络当中；跨网路需要逐个网络使用**

![image-20230623212137813](https://img-blog.csdnimg.cn/9757a4a15dfd4959a5f2558ab3fc46e7.png)

## 交换局域网

###  概述

* 局域网：Local Area Network ( LAN )
* 多址访问协议广泛应用于局域网
* 基于随机访问的CSMA/CD广泛应用于局域网
* 局域网**按拓扑结构**进行分类：
  * 星形网、环形网、总线网、树形网和网状网

* 计算机与局域网通过**网络接口板进行连接**
  * 网络接口板又称**通信适配器**（Adapter）或**网络接口卡NIC**（Network Interface Card），通常我们称为“**网卡**”

### 链路层寻址和ARP

* 每个节点有网络层地址和链路层地址
  * 网络层地址
    * 节点在**网络中**分配的一个**唯一地址（IP地址）**。用于把分组送到目的IP网络。长度为32比特（IPv4）
  * 链路层地址
    * 又叫做**MAC地址**或物理地址、局域网地址
* MAC地址
  * LAN地址、物理地址
  * 节点“**网卡”本身所带的地址（唯一**）
  * MAC地址长度通常为**6字节(48比特**)，共**248**个
  * 6字节地址用16进制表示，每个字节表示为一对16进制数
    * 1A-2F-BB-76-09-AD
  * **网卡的MAC地址是永久的**（生产时固化在其ROM里）

#### MAC地址分配

* ![image-20230614205610876](https://img-blog.csdnimg.cn/092ced73065a4056a16cccc1ce2ff0f7.png)
* MAC 地址是**平面结构**
  * 带有同一网卡的节点，在任何网络中都有同样的MAC地址

#### AMC地址识别

* 广播信道的局域网中，一个节点发送的帧，在信道上**广播传输，其他节点都可能收到该帧**
* 大多数情况，一个节点只向某个特定的节点发送
* 由“**网卡**”负责MAC地址的封装和识别
* **发送适配器**：
  * 将目的MAC地址封装到帧中，并发送。**所有其他适配器都会收到这个帧**。
* **接收适配器**：
  * 检查**帧的目的MAC地址是否与自己MAC**地址相匹配：
  * 匹配：**接收该帧，取出数据报，并传递给上层。不匹配：丢弃该帧**
* 广播帧：发送给所有节点的帧     全1地址：FF-FF-FF-FF-FF-FF

#### 回顾：节点的三种不同地址

![image-20230614210610683](https://img-blog.csdnimg.cn/2d4b2fc1262548839143129d4c1819ab.png)

> 刚刚我们讲到在单条链路上，数据帧的接收是根据目的MAC地址。
>
> 这里我们简单回顾下，一个节点的三种不同的地址表示。
>
> 第一种表示是：**应用层的主机名，例如域名**；
>
> 第二种表示是：**网络层的IP地址**，用于**在网络层寻址**，即路由器根据目的IP地址来进行转发；主机也根据目的IP地址是否是本机地址来判断是否接收。
>
> 第三章表示是：**链路层的MAC地址**，用于在链路层寻址，即实际链路传输时，每个主机**网卡根据目的MAC地址是否是本机的MAC地址来判断是否接收**。
>
> 在本页的例子中，标出了每个主机的IP地址和每个网卡的MAC地址。

#### 回顾：地址之间的转换

![image-20230614210729898](https://img-blog.csdnimg.cn/5245deb687d6409dbcd52018e662f54c.png)

> 那么，我们说实际的**数据帧发送**，**需要目的主机的IP地址和MAC地址**，这就需要提供地址之间的转化服务。
>
> 例如已知主机名，怎么查找该**主机名对应的IP地址**呢？这就需要用到**DNS域名解析服务**；
>
> 那么如果已知目的主机的IP地址，怎么查找它在同一个局域网中的MAC地址呢？这就需要用到**ARP协议**。ip->MAC
>
> 我们说ARP协议的主要作用是**将IP地址解析为其对应的MAC地址。**
>
> 需要说明的是ARP协议**只为在同一个局域网内部的节点进行IP地址解析**。

### ARP地址地址解析协议

![image-20230615205225915](https://img-blog.csdnimg.cn/18b3482643294b2e97fd31f3e82431fe.png)

* *ARP**表**:* 局域网上的每个节点(主机、路由器)都有这个表

  •为某些局域网节点进行IP/MAC地址映射：

     **< IP address; MAC address; TTL>**

  •TTL (存活时间): **地址映射将被删除的时间**（通常为20分钟）

#### 两个主机位于同一个LAN

* 1.主机A希望发送数据报给主机B
  * B的MAC地址**不在A的ARP映射表中**
* 2.主机A **广播 ARP查询分组, 其中包含B的IP地址** 
  * 目的MAC地址 = FF-FF-FF-FF-FF-FF
  * 局域网中**所有节点收到ARP查询分组**
* 3.主机B收到ARP查询分组，**返回B的MAC地址给主机A**
  * 包含有B的MAC地址的帧发送给主机A(单播)
* 4.主机A在它的ARP表中缓存 **IP-to-MAC** **地址对，**直到信息
  * 软状态：信息超时会被删除，除非有新的更新消息
  * ARP是即插即用的：
    * 节点创建ARP表不需要网络管理员的干预

#### 发送数据报到子网以外

![image-20230615205645829](https://img-blog.csdnimg.cn/36b7cb82ca5748f6add34b0b6d666e7c.png)

* 主机A构建IP数据报，**源地址是A的IP地址，目的地址是B的IP地址**

* 主机A构建链路层数据帧，**目的MAC地址是路由器左边端口的MAC地址**

* 1.![image-20230615205732121](https://img-blog.csdnimg.cn/5532cb0f33d046e981c7d2eb10b6f485.png)

  > 首先主机A构建IP数据报，数据报的源IP地址是自己的111.111.111.111，目的IP地址是主机B的IP地址222.222.222.222。
  >
  > 那么该数据报封装成数据帧的源MAC地址是自己的MAC地址，74-29-9C-E8-FF-55，目的MAC地址是谁的呢？是B主机的MAC地址，还是路由器左边端口的MAC地址呢？
  >
  > 我们首先分析这个数据帧的发送路径。我们说当主机A判断该数据报的接收主机与自己不在同一个局域网时，它会首先将数据报发送到自己的第一跳路由器，即这里的路由器R，
  >
  > 因此该数据帧的目的MAC地址应该是R的左边端口的MAC地址，E6-E9-00-17-BB-4B。

* 2.![image-20230615210113780](https://img-blog.csdnimg.cn/00a0cd18841443ce999e1f3664646820.png)

  > 该数据帧到达路由器R后，路由器R接收数据帧，然后抽取出数据报递交给网络层，网络层根据目的IP地址，判断该数据报要往右边的端口转发，且接收主机B与自己右边端口属于同一个局域网。

* 3.![image-20230615211104130](https://img-blog.csdnimg.cn/ec98a9d4e1654f48a346ecd5469e312b.png)

  > 因此向右边端口输出数据帧时，数据帧的源MAC地址是路由器右边端口的MAC地址1A-23-F9-CD-06-9B，
  >
  > 数据帧的目的MAC地址是主机B的MAC地址49-BD-D2-C7-56-2A。

* 这里需要强调的是，在整个传输过程中，**数据报的源IP地址和目的IP地址是不会发生改变的，改变的只是数据帧的源和目的MAC地址。**



### 以太网

#### 以太网的帧结构

* 发送方：
  * 发送适配器**将IP数据报封装成以太网帧**，并传递到物理层
* 接收方：
  * 接收适配器**从物理层收到该帧，取出IP数据报**，并传递给网络层
* ![image-20230615212904236](https://img-blog.csdnimg.cn/52cc048deb39486f88ece178bc7b688d.png)

> 接着，我们再介绍以太网的帧结构，如图所示，包括了前同步码、目的MAC地址、源MAC地址、类型、数据和CRC校验码。
>
> 注意这里CRC检验的数据只包含目的MAC地址、源MAC地址、类型、数据四部分。
>
> 首先发送方的发送适配器将IP数据报封装成以太网帧，并传递到物理层。
>
> *接收方的*接收适配器从物理层收到该数据帧，抽取出IP数据报，并传递给网络层。
>
> Ref : https://blog.csdn.net/eliot_shao/article/details/123473548

* 前同步码(8 字节)![image-20230615212923620](https://img-blog.csdnimg.cn/bddec30b610840539aeddf4f7a7c74fc.png)

  * > 前同步码有8个字节，其中前7字节是“10101010”，最后一个字节是“10101011”。
    >
    > 前同步码的作用是使接收方和发送方的时钟同步，接收方一旦**收到连续的8字节**前同步码，可确定有帧传过来。
    >
    > 注意：前同步码是“无效信号”，接收方收到后删除，不向上层传。CRC的校验范围不包括前同步码。

* 源、目的MAC地址(各6字节)![image-20230615213135997](https://img-blog.csdnimg.cn/6dbdf1170ac64bdaa4d331b58ff268d7.png)

  >然后是各6个字节的源、目的MAC地址。
  >
  >如果主机A向主机B发送一个IP数据报，**主机B只接收目的MAC地址与自己MAC地址匹配的数据帧或广播地址的数据帧**，并将数据字段的内容传递给网络层。否则，丢弃该帧。

* 类型字段(2 字节)

  * ![image-20230615213210068](https://img-blog.csdnimg.cn/d74ae618559a45d092ad7b6d109fbf93.png)

  * > 帧结构中类型字段主要是支持以太网中的多种网络层协议的**复用的**，绝大多数这里的类型是指IP协议。

* 数据字段(46-1500字节)![image-20230615213434405](https://img-blog.csdnimg.cn/52389e06268a47ee9e94c07a0f8e5ece.png)

  * 然后是数据字段，*以太网的最大传输单元**MTU**是**1500**字节，最小长度是**46**字节。*

* 循环冗余检测CRC(4字节)![image-20230615213459966](https://img-blog.csdnimg.cn/15d70661a2f74e4692ac3ad63155035b.png)

  帧结构的尾部**是CRC循环冗余校验码**。它主要是用于帮助接收主机检测数据帧中是否出现比特差错。



#### 不可靠的无连接服务

* 以太网向网络层提供的服务：
  * 无连接服务：
    * 通信时，**发送方适配器不需要先和接收方适配器"握手"**
  * 不可靠服务：
    * 接收到的帧可能含有比特差错
      * 收到正确帧，不发确认帧
      * 收到出错帧，丢弃该帧，**不发否定帧**
      * 发送适配器不会重发出错帧
      * 丢弃数据的恢复是通过终端**传输层的可靠数据传输机制**来实现的

### 交换机SWITCH

#### 集线器HUB

**集线器连接下的网络虽然物理上看起来不是总线型的，但是逻辑上仍然是总线型的**

**使用CSMA/CD协议**

**集线器只工作在物理层，他的每个接口只是简单的转发比特流，碰撞检测的事情交给各站的网卡进行检测**

![image-20230624101402969](https://img-blog.csdnimg.cn/83a47f64e0a844e7ad7c24a48d447fd2.png)

使用集线器HUB在物理层扩展以太网

![image-20230624101639421](https://img-blog.csdnimg.cn/c12e4acc14ab471bbd6bc1aac5795869.png)

**使用集线器连接的以太网就相当于是把总线型的给画的好看了点，其实没什么区别，用的还是CSMA/CD协议调节各个主机使用总线，还要进行碰撞检测，只能工作在半双工模式，收发帧不能同时进行**

#### 交换机与集线器的对比

##### 比较

![image-20230626192052973](https://img-blog.csdnimg.cn/f5a79713c4c44866a823c134d318481f.png)

![image-20230626192105334](https://img-blog.csdnimg.cn/403f945b44ba48778847218aec6a0933.png)

**某站的信号经过集线器会转发给广播域中的所有其他主机，但是经过交换机之后，由于内部的设置会只转发给目的主机**

![image-20230624101832631](https://img-blog.csdnimg.cn/1f132ecbe0e44f5ba3b10ad8cff07e8a.png)

**以太网交换机有多个接口，一般工作在全双工模式，不用考虑碰撞检测(不适用CSMA/CD协议)，能同时连通多个接口!**

![image-20230624102447140](https://img-blog.csdnimg.cn/72c19c22a0bb44d49960d111950d54a4.png)

**关于碰撞的问题，集线器收到帧之后就会直接向其他所有主机进行传递，这里必然就会涉及到碰撞的问题**

**而交换机，当交换机收到多个帧的时候，为了避免碰撞会将这些帧进行缓存，之后再进行逐一转发，避免了碰撞的问题**

##### 交换机和集线器扩展以太网

单播帧

![image-20230624103048893](https://img-blog.csdnimg.cn/8a7fa40579fa4876859aaffe21afe755.png)

广播帧

![image-20230624103106429](https://img-blog.csdnimg.cn/84425071577a47e18da441d7e9f73e30.png)

可能发生碰撞的时候

![image-20230624103214629](https://img-blog.csdnimg.cn/d6fd7d9155264618a435edf342b0ca00.png)

**因此，集线器扩大了广播域，也扩大了碰撞域；而交换机扩大了广播域，但是隔离了碰撞域!!!**

![image-20230624103312938](https://img-blog.csdnimg.cn/d952b357bff84750b05dd8171510bef2.png)

* **链路层设备**
  * **存储转发数据帧**
  * **检查**到达的数据帧的MAC地址，有选择的转发数据帧到一个或多个输出链路，当数据帧被转发到一个共享网段时，使用CSMA/CD来访问共享链路
* **透明**
  * 主机不关心是否存在交换机
* **即插即用和自学习**
  * 交换机不需要手工配置
* ![image-20230615214505580](https://img-blog.csdnimg.cn/0be721fb1ce44b4391f07fba8d9cc06b.png)

> 本次课将详细讲解链路层交换机的工作原理。
>
> 首先交换机是属于链路层的设备，其主要作用是**存储转发数据帧。**
>
> 对于到达交换机的数据帧，交换机首先**检查其目的MAC地址**，然后根据MAC地址，有选择的将数据帧转发到一个或多个输出链路；
>
> 如果输出链路是一个共享网段，将使用CSMA/CD来访问共享链路。我们这里给出了一幅图来帮助大家理解后面这句话。
>
> 在这幅图中A、B、C主机和交换机的端口1由集线器设备互连，因此这里**，A、B、C主机和交换机的端口1构成了一个共享网段**，在共享链路发送数据帧，需要用到我们前面学习到的以太网链路访问协议CSMA/CD。
>
> 链路层交换机的第二个特点是透明，这里的透明是指的当一个主机向另一个主机发送数据帧时，它并不会知道某个交换机会收到这个数据帧，并将其转发到另一个节点。
>
> 交换机的第三个特点是即插即用和自学习，也就是说交换机是不需要手工配置的，插上就可以用。

#### 支持多节点同时传输

![image-20230615214659240](https://img-blog.csdnimg.cn/f68223be37ee4b688ea856af2b4629ad.png)

> 在组网时加入交换机后，可以支持多个节点同时传输数据帧。
>
> 可以看上边这幅图，每个主机由单独的链路与交换机端口相连，因此交换机每个端口对应的链路和主机是一个**独立的碰撞域。**
>
> 又因为交换机对于收到的数据帧可进行缓存，因此在上边这幅图中，A主机和B主机同时发送数据帧，将不会发生冲突。
>
> 因此交换机具有较高的转发率。

#### 以太网自学习和转发帧的过程(自学习算法)

##### 考虑以下过程

![image-20230624103924717](https://img-blog.csdnimg.cn/273911be62754236870a814ba8ecf030.png)

A给B发送帧，进入交换机1中，先进行登记，记录A的MAC地址和接口1，然后找B的MAC地址，找不到，进行广播，接口3的B收到发现正确，接受；C则丢弃；到4号接口转发到交换机2中，帧进入交换机2中先进行登记，登记A的MAC地址和接口2，然后进行广播，都不匹配，则都丢弃，这就是一个完整的过程

后面还有两个过程

![image-20230624104855273](https://img-blog.csdnimg.cn/4017dc2910b6413d896b95c7be2a4cd9.png)

丢弃帧的例子

![image-20230624105132560](https://img-blog.csdnimg.cn/0bae4a15b96f4badb4e4229c81f142d6.png)

**G发送帧到A，这个帧在分岔口两边传播，给A并接受，到交换机的时候先进行登记，然后查找，发现A 1，意思是从哪里来回哪里去，这显然是没必要转发的，于是丢弃**

每条记录的持续时间不是永久的，会定期删除!!!

![image-20230624105419966](https://img-blog.csdnimg.cn/e822302095674cd78a2ccf70fa33b7ba.png)

##### 转发表

![image-20230615215151514](https://img-blog.csdnimg.cn/bcad9f4cd7a6455f8120e05f623fd832.png)

> 在右边这幅图中，我们有这样一个疑问：交换机是怎么知道A’可通过端口4达到， B’ 可通过端口5到达呢？
>
> **这是因为每个交换机都有一个转发表，其中的条目如下：**(主机的MAC地址，到达主机的端口，时戳)；
>
> 因此当数据帧的目的MAC地址为A’主机时，我们通过查找相应的转发表项，就可获知该主机对应的端口。
>
> 那么转发表中的条目是怎么建立的呢？我们说是通过自学习机制。

* 自学习![image-20230615215317577](https://img-blog.csdnimg.cn/d58fe573c9964ab68a5e844d6016a08c.png)

> 下面我们就来介绍交换机的自学习机制。非常简单。
>
> 每当交换机收到一个数据帧时，交换机会学习发送主机的位置：**及进入的局域网段和到达端口，并在转发表中进行记录**。
>
> 如这里的例子所示，主机A发送数据帧给主机A’，数据帧到达交换机时，交换机会在转发表中记录这样一个表项：
>
> A主机的MAC地址和可达端口号1，生存时间60秒，这就表示通过端口1可达到A主机。

##### 数据帧的过滤/转发

* ![image-20230615220318143](https://img-blog.csdnimg.cn/d288719ebd964207bf3615ff80865258.png)

> 下面我们来学习交换机收到数据帧后，是如何进行查表转发的。我们说根据如下规则：
>
> 首先，**记录**到达链路和发送主机的MAC地址；
>
> 第二步，使用数据帧的目的MAC地址，在转**发表中进行检索：**
>
> 如果在转发表条目中找到对应的MAC地址，则执行：
>
> 如果**目的MAC地址对应的端口**与**数据帧的到达端口相同**，说明接收主机属于同一个共享网段，则**直接将该数据帧丢弃**。**因为接收主机也会收到该数据帧**；
>
> 否则，转发端口与达到端口不一致，则将该数据帧转发到指定端口
>
> 如果数据帧的目的MAC地址在转发表中没有找到，则交换机将该数据帧向除到达端口之外的所有端口转发，也就是**泛洪**。



##### 自学习/转发例子![image-20230615220549451](https://img-blog.csdnimg.cn/5c3385332b4e42b0a8cf2fe20bd74a3c.png)

> 我们来看一下自学习和转发的例子。
>
> 这里初始时转发表是空的，当主机A发送数据帧给主机A’时，该数据帧到达交换机，
>
> 交换机首先根据收到数据帧的端口和该数据帧的源MAC地址，建立表项1，说明通过端口1可达到主机A，这就是自学习。
>
> 然后交换机根据数据帧的目的MAC地址（A’）在转发表中查找，由于没有找到A’的MAC地址，则交换机将该数据帧向除1端口之外的所有端口转发，
>
> 只有A’主机会发现数据帧的目的MAC地址与自己的MAC地址一致，接收该数据帧。
>
> 注意，这里主机A’发往主机A的数据帧，在到达交换机后，由于转发表中已经有目的MAC地址对应的表项，因此交换机将只向1端口转发数据帧。

#### 交换机互连

* ![image-20230615221022380](https://img-blog.csdnimg.cn/5d7bacdb82ea489984cc685ab1a6fd90.png)

> 交换机也可以进行**互连，以组成更大的局域网**。如本页的图所示。
>
> 那么请大家思考，这样一个问题，如果主机A发送数据帧给主机G,那么交换机S1是怎么知道需要先把数据转发到S4和S3的？
>
> 我们说仍然是通过自学习。当数据帧到达S1时，可能S1的转发表中没有G主机的MAC地址的表项，于是S1将该数据帧泛洪，那么S4的端口也会收到这个泛洪的数据帧，
>
> 如果S4的转发表也没有G主机的MAC地址对应的表项，则S4会继续泛洪，于是S3也会收到数据帧，如果S3的转发表仍然没有G主机的MAC地址，则S3会继续向它的端口泛洪，直到数据帧到达G主机。

* 多个交换机自学习的例子![image-20230615221124088](https://img-blog.csdnimg.cn/887859ea308740098420560737593e69.png)

#### 交换机交换特点和方式

* 特点

  * 识别目的MAC地址，根据交换表进行端口选择
  * 识别源MAC地址更新交换表

* 在识别目的MAC地址和源MAC地址的过程中是否需要接收并缓存完整的帧呢？

  * 在识别目的MAC地址和源MAC地址的过程中，**需要接收并缓存完整的帧**。这是因为MAC地址是位于数据链路层的帧的**头部**中，用于标识帧的源和目的设备。

    当一个设备接收到一个帧时，它需要读取帧头部中的目的MAC地址和源MAC地址字段来确定该帧是否是针对自己的，或者是从哪个设备发送过来的。因此，设备需要接收并缓存完整的帧，以便能够从帧头部提取MAC地址信息进行判断和处理

* 交换方式

  * **存储转发**(缓存整个帧后再转发)
  * **快速分组**(直通交换)
    * 识别出目的地址直接转发

存储转发交换方式

![image-20230615221909190](https://img-blog.csdnimg.cn/7a6bb4e5baa94d8d9b228580cff1cf81.png)

快速分组交换方式

![image-20230615221938880](https://img-blog.csdnimg.cn/b9e9bff22ac4432fbb9640f16363c74d.png)

> 存储转发：具有**差错检测**功能，**转发时延较大**，适用于**出错率高的链路**。
>
> 快速分组又称直通交换：**不具有差错检测功能，转发时延较小**，适用于时延要求高，**出错率低的链路**。

#### 路由器和交换机的区别

![image-20230615222230911](https://img-blog.csdnimg.cn/d473d1f6edf74e77b8ff7d4d2e9b1e5c.png)

> 最后我们将交换机和路由器进行简单的对比。
>
> 首先，路由器和交换机都是存储转发设备（中转设备），其中路由器是**网络层设备**，交换机是**链路层设备**。
>
> 第二，路由器和交换机**都需要维护转发表**，其中路由器使用**路由算法**来计算转发表，**基于IP地址转发**；而交换机是通过泛**洪和自学习**来建立转发表，**基于MAC地址**进行数据帧转发。

### 虚拟局域网VLAN

以太网的规模变大之后，随之而来的就是广播域不断增大，广播会导致很大的弊端!!!

![image-20230624110432468](https://img-blog.csdnimg.cn/3c7ba40e6ed64f8d8c7e2351f4ca6b74.png)

如何缓解这个问题呢？

可以使用路由器，**路由器默认情况下不对广播数据包进行转发，**所以可以隔绝广播域

![image-20230624110602013](https://img-blog.csdnimg.cn/645c2c9a7b62489e9339a3f60b4931c0.png)

但是路由器成本太高了，在局域网内部尽量少的使用路由器，所以这个时候可以用虚拟局域网VLAN技术

![image-20230624110819408](https://img-blog.csdnimg.cn/82dd33b5a33e45ca8b7b76690dd14ef4.png)

**同一个VLAN内部可以广播通信，不同的不可以广播通信；VLAN的划分与物理位置无关，只与人为的设置相关!!!**

# 第六章 网络编程

考试只会考写步骤，代码在实验里就写过了

## 步骤

![image-20230626192916119](https://img-blog.csdnimg.cn/d85eb3391d324e59b0875da772457970.png)

![image-20230626194828716](https://img-blog.csdnimg.cn/3305e3c6f7464e41a4fa3abdfd613364.png)